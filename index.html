<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CATNOODLE v3.4</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Noto+Sans+KR:wght@500;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #f5f6fa;
            --board-bg: #2d3436;
            --hole-color: #151819;
            --tray-bg: #2d3436;
            --primary-btn: #4834d4;
            --secondary-btn: #eb4d4b;
            --reset-btn: #f0932b;
            --control-color: #636e72;
            --text-color: #2d3436;
            --cell-size: 32px; 
            --modal-bg: #1e1e1e;
            --modal-text: #ffffff;
            --border-color: #3d4648; 
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Gowun Dodum', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex; flex-direction: column; align-items: center;
            height: 100vh;
            overflow: hidden;
            touch-action: none; 
            user-select: none; -webkit-user-select: none;
            padding-bottom: 20px; 
        }

/* 1. í—¤ë” ìˆ˜ì •: ì–‘ì˜†ì— QR ë²„íŠ¼ì´ ë“¤ì–´ê°ˆ ê³µê°„(60px)ì„ ë¯¸ë¦¬ ë¹„ì›Œë‘¡ë‹ˆë‹¤ */
header { 
    position: relative;
    flex: 0 0 auto;
    /* ğŸ‘‡ ìœ„ìª½ 15px, ì–‘ì˜† 60px íŒ¨ë”© (í•µì‹¬!) */
    padding: 15px 60px 0 60px; 
    margin: 5px 0 5px; 
    text-align: center; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    gap: 10px; 
    width: 100%; /* ì „ì²´ í­ ë‹¤ ì“°ê¸° */
}

        
        h1 { 
            margin: 0; font-size: 1.8rem; color: #2d3436; 
            font-family: 'Oswald', sans-serif; 
            font-weight: 700; letter-spacing: 0px; 
            display: flex; align-items: center; gap: 8px;
        }
        
        .title-icon {
            width: 40px; height: 40px;
            object-fit: contain;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.15));
        }

/* ğŸ†• ë„ì „ì ë²„íŠ¼ (ì™¼ìª½ ìƒë‹¨) */
.btn-challenger {
    position: absolute;
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
    background: #fab1a0; /* ì‚´êµ¬ìƒ‰ í¬ì¸íŠ¸ */
    border: none;
    width: 36px; height: 36px;
    border-radius: 50%;
    font-size: 1.2rem;
    cursor: pointer;
    box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    z-index: 100;
    transition: transform 0.2s;
}
.btn-challenger:hover { transform: translateY(-50%) scale(1.1); }

/* ğŸ†• íƒ€ì´ë¨¸ ì»¨í…Œì´ë„ˆ (PC) */
#timer-container {
    position: absolute;
    /* ğŸ‘‡ ì™¼ìª½ ê°„ê²©ì„ ì¤„ì—¬ì„œ íƒ€ì´ë¨¸ê°€ ë²„íŠ¼ì— ë” ê°€ê¹ê²Œ (ê¸°ì¡´ 70px -> 65px) */
    /* í•„ìš” ì‹œ ì´ ìˆ«ìë¥¼ ì¡°ê¸ˆì”© ì¡°ì ˆí•´ ë³´ì„¸ìš” */
    left: 70px; 
    top: 50%;
    transform: translateY(-50%);
    text-align: left;
    
    display: none; 
    flex-direction: column; 
    gap: 2px;
}

/* íƒ€ì´ë¨¸ ìˆ«ì ë””ìì¸ (ê¸°ì¡´ ìœ ì§€) */
#game-timer {
    font-family: 'Oswald', sans-serif;
    font-weight: 700;
    font-size: 1.6rem;
    color: #2d3436;
    font-variant-numeric: tabular-nums;
    letter-spacing: 0.5px;
    line-height: 1;
    /* ğŸ‘‡ ì™¼ìª½ íŒ¨ë”© ì œê±° (ì™„ì „í•œ ì™¼ìª½ ì •ë ¬) */
    padding-left: 0; 
    margin-left: 0;
}

/* BEST ê¸°ë¡ ì»¨í…Œì´ë„ˆ (Flexë¡œ ë°°ì¹˜) */
#best-record {
    display: flex;
    align-items: baseline;
    justify-content: flex-start;
    /* ğŸ‘‡ ì˜¤ë¥¸ìª½ ê°„ê²© ì¶•ì†Œ (8px -> 4px) */
    gap: 4px; 
    
    /* ğŸ‘‡ íƒ€ì´ë¨¸ì™€ ì™¼ìª½ ë¼ì¸ì„ ì •í™•íˆ ë§ì¶”ê¸° ìœ„í•´ ë¯¸ì„¸ ì¡°ì • */
    /* ì¥í‰ ì¶•ì†Œ(scaleX) ë•Œë¬¸ì— ì‹œê°ì ìœ¼ë¡œ ì™¼ìª½ì´ ë¹„ì–´ ë³´ì¼ ìˆ˜ ìˆì–´ ë§ˆì§„ìœ¼ë¡œ ë‹¹ê¹€ */
    margin-left: 1px; 
    margin-top: -2px;
}

/* 1. í•œê¸€ í…ìŠ¤íŠ¸ (Noto Sans KR + ì¥í‰ 80%) */
.best-txt {
    font-family: 'Noto Sans KR', sans-serif;
    font-weight: 700;
    font-size: 0.95rem;
    color: #636e72;
    
    display: inline-block;
    transform: scaleX(0.9);
    /* ğŸ‘‡ PC: ì™¼ìª½ ê¸°ì¤€ìœ¼ë¡œ ì¶•ì†Œí•´ì•¼ íƒ€ì´ë¨¸ì™€ ì‹œì‘ì ì´ ë§ìŒ */
    transform-origin: left; 
    white-space: nowrap;
}

/* 2. ìˆ«ì í…ìŠ¤íŠ¸ (Oswald) */
.best-time {
    font-family: 'Oswald', sans-serif;
    font-weight: 700;
    font-size: 1.0rem;
    color: #636e72;
    letter-spacing: 0.5px;
}

/* 1ï¸âƒ£ ê³µí†µ ë°˜ì‘í˜• (PC ì°½ ì¤„ì„ & ëª¨ë°”ì¼ ëª¨ë‘ ì ìš©) */
/* ğŸ‘‰ íƒ€ì´ë¨¸ í•˜ë‹¨ ë°°ì¹˜, ê²Œì„ ìœ ë‹› ì •ë ¬ ë“±ì€ í™”ë©´ ë„ˆë¹„ë§Œ ë³´ê³  íŒë‹¨ */
@media (max-width: 700px) {
    #timer-container {
        position: fixed;
        left: 0;
        bottom: 20px;
        width: 100%;
        top: auto;
        transform: none;
        
        background: transparent;
        box-shadow: none;
        padding: 0 30px;
        border-radius: 0;
        
        /* ê°€ë¡œ ë°°ì¹˜ (íƒ€ì´ë¨¸ | ê¸°ë¡) */
        flex-direction: row; 
        justify-content: space-between;
        align-items: baseline;
        z-index: 8000;
        pointer-events: none;
    }

    #game-timer {
        color: #2d3436;
        font-size: 1.6rem;
        text-shadow: 0 2px 10px rgba(255,255,255,0.8);
        line-height: 1;
    }

    #best-record {
        justify-content: flex-end;
        margin: 0;
        border: none;
        padding: 0;
    }
    
    .best-txt {
        transform-origin: right;
    }
    
    #game-unit {
        justify-content: center;
        padding-top: 0;
        padding-bottom: 30px;
    }
}

/* 2ï¸âƒ£ ì° ëª¨ë°”ì¼ ì „ìš© (í„°ì¹˜ ìŠ¤í¬ë¦° ê¸°ê¸°ë§Œ ì ìš©) */
/* ğŸ‘‰ pointer: coarse ì¡°ê±´ì€ 'ì†ê°€ë½'ì„ ì‚¬ìš©í•˜ëŠ” ê¸°ê¸°ë¥¼ ì•„ì£¼ ì •í™•í•˜ê²Œ ì°¾ì•„ëƒ…ë‹ˆë‹¤ */
@media (max-width: 700px) and (pointer: coarse) {
    /* 1. ë²„íŠ¼ë“¤ì„ ìµœìƒë‹¨ êµ¬ì„ìœ¼ë¡œ ê°•ì œ ì´ë™ */
    .btn-challenger, .btn-qr {
        top: 25px !important; 
        transform: none !important;
    }

    /* 2. í—¤ë” ìœ—ê³µê°„ í™•ë³´í•˜ì—¬ ì œëª©ì„ ì•„ë˜ë¡œ ë°€ê¸° */
    header {
        /* ê¸°ì¡´ 15px -> 60pxë¡œ ëŠ˜ë ¤ì„œ ì œëª©ì„ ì•„ë˜ë¡œ ê¾¹ ëˆ„ë¦…ë‹ˆë‹¤ */
        padding-top: 60px !important; 
        margin-bottom: 15px !important;
        
        /* ğŸ’¡ í˜¹ì‹œ ëª¨ë¥¼ flex ì •ë ¬ ì¶©ëŒ ë°©ì§€ìš© (ì•ˆì „ì¥ì¹˜) */
        align-items: flex-end; 
        padding-bottom: 10px;
    }

    /* 3. ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ê°„ê²© ë¯¸ì„¸ ì¡°ì • */
    .controls {
        margin-bottom: 10px;
    }
}
        
/* 2. ë¬¼ìŒí‘œ ë²„íŠ¼: ì›ë˜ëŒ€ë¡œ ë³µêµ¬ (ê¸°ì¡´ ì½”ë“œì— ìˆë‹¤ë©´ í™•ì¸ë§Œ í•˜ì„¸ìš”) */
.btn-help {
    width: 24px; height: 24px; border-radius: 50%;
    background: #b2bec3; color: white; border: none; 
    font-weight: bold; font-size: 0.9rem; cursor: pointer;
    font-family: 'Oswald', sans-serif;
    /* Flex ì•„ì´í…œìœ¼ë¡œì„œ ì¤‘ì•™ ì •ë ¬ ìœ ì§€ */
}

/* 3. QR ë²„íŠ¼ ìˆ˜ì •: ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ì„ ì™„ë²½í•˜ê²Œ ë³´ì • */
.btn-qr {
    position: absolute;
    right: 15px;         /* ì˜¤ë¥¸ìª½ ë²½ì—ì„œ 15px ë–¨ì–´ì§ */
    top: 50%;            /* ë¶€ëª¨ì˜ ì •ì¤‘ì•™ ë†’ì´ */
    /* ğŸ‘‡ -20% ëŒ€ì‹  -50%ë¥¼ ì¨ì•¼ ì •í™•í•œ ìˆ˜ì§ ì¤‘ì•™ì´ ë©ë‹ˆë‹¤ */
    transform: translateY(-50%); 
    
    background-color: #dfe6e9;
    color: #636e72;
    border: none;
    padding: 6px 12px;
    border-radius: 8px;
    font-weight: bold;
    font-family: 'Oswald', sans-serif;
    font-size: 0.85rem;
    cursor: pointer;
    z-index: 100;
    white-space: nowrap; /* ê¸€ì ì¤„ë°”ê¿ˆ ë°©ì§€ */
}

/* ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ íš¨ê³¼ (ê¸°ì¡´ ì½”ë“œì— í´ë˜ìŠ¤ëª…ì´ ë‹¤ë¥¼ ìˆ˜ ìˆì–´ ì¶”ê°€) */
.btn-qr:hover {
    background: #b2bec3; 
}
        
/* ğŸ‘‡ ê¸°ì¡´ í´ë˜ìŠ¤ ìˆ˜ì •: ê¸°ì¤€ì (relative) ì„¤ì • ì¶”ê°€ */
.qr-modal-content {
    position: relative; /* ğŸ“ X ë²„íŠ¼ì´ ì´ ìƒìë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìœ„ì¹˜ë¥¼ ì¡ìŠµë‹ˆë‹¤ */
    
    /* (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€) */
    background: var(--modal-bg); color: var(--modal-text);
    padding: 20px; border-radius: 12px; border: 1px solid #444;
    width: 85%; max-width: 320px;
    height: 40vh; /* í™”ë©´ ë†’ì´ì˜ 1/3 */
    display: flex; flex-direction: column; align-items: center; justify-content: center; /* ê°„ê²© ì¡°ì • */
    gap: 15px; /* ìš”ì†Œ ì‚¬ì´ ê°„ê²© */
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    animation: popIn 0.2s ease-out;
}

/* ğŸ‘‡ ğŸ†• ìš°ì¸¡ ìƒë‹¨ X ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
.close-x-btn {
    position: absolute; /* ì ˆëŒ€ ìœ„ì¹˜ */
    top: 15px;          /* ìœ„ì—ì„œ 15px */
    right: 15px;        /* ì˜¤ë¥¸ìª½ì—ì„œ 15px */
    
    background: transparent; /* íˆ¬ëª… ë°°ê²½ */
    border: none;
    color: #888;        /* ê¸°ë³¸ì€ íšŒìƒ‰ */
    font-size: 1.8rem;  /* í¬ê¸° í‚¤ì›€ */
    line-height: 1;
    font-weight: 400;   /* ë„ˆë¬´ êµµì§€ ì•Šê²Œ */
    cursor: pointer;
    padding: 0;
    transition: color 0.2s;
}

.close-x-btn:hover {
    color: #ffffff; /* ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ í°ìƒ‰ìœ¼ë¡œ ê°•ì¡° */
}

/* 3. QR ëª¨ë‹¬ ì „ìš© ìŠ¤íƒ€ì¼ (ë†’ì´ 1/3) */
.qr-modal-box {
    background: var(--modal-bg);
    color: var(--modal-text);
    padding: 20px;
    border-radius: 12px;
    width: 85%;
    max-width: 320px;
    height: 40vh; /* ğŸ’¡ í™”ë©´ ë†’ì´ì˜ 1/3 ê³ ì • */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-evenly; /* ë‚´ë¶€ ìš”ì†Œ ê°„ê²© ê· ë“± */
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    border: 1px solid #444;
    animation: popIn 0.2s ease-out;
}
        
        .controls { 
            flex: 0 0 auto;
            display: flex; gap: 8px; margin-bottom: 5px; 
            flex-wrap: wrap; justify-content: center; z-index: 20; 
        }
/* ğŸ‘‡ ë¹„í™œì„±í™”ëœ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
button.game-btn:disabled {
    background-color: #b2bec3 !important; /* ì—°í•œ íšŒìƒ‰ */
    color: #dfe6e9 !important; /* ê¸€ìë„ ì—°í•˜ê²Œ */
    cursor: not-allowed; /* ê¸ˆì§€ ì»¤ì„œ */
    box-shadow: none; /* ê·¸ë¦¼ì ì œê±° */
    transform: none !important; /* ëˆŒë¦¬ëŠ” íš¨ê³¼ ì œê±° */
}
        
        select, button.game-btn {
            padding: 8px 14px; border-radius: 6px; border: none; font-size: 0.95rem;
            cursor: pointer; box-shadow: 0 3px 6px rgba(0,0,0,0.1); font-weight: 400; color: white;
            font-family: 'Gowun Dodum', sans-serif;
        }
        select { background: var(--control-color); color: white; font-weight: bold;}
        .btn-gen { background: var(--control-color); } 
        .btn-reset { background: var(--reset-btn); }
        .btn-answer { background: var(--secondary-btn); }

        #game-unit {
            display: flex; flex-direction: column; align-items: center;
            position: relative;
            flex: 1 1 auto; 
            width: fit-content;
            min-width: 300px;
            margin: 0;
            justify-content: flex-start; 
            padding-top: 3vh; 
            padding-bottom: 20px; 
            padding-left: 40px
            padding-right: 40px
        }

        @media (max-width: 700px) {
            #game-unit {
                justify-content: center; 
                padding-top: 0;
                padding-bottom: 30px; 
            }
        }

        .game-panel {
            width: 100%;
            background-color: var(--board-bg);
            padding: 10px; border-radius: 12px;
            border: 4px solid var(--border-color);
            box-shadow: 
                0 20px 40px rgba(0,0,0,0.3), 
                0 10px 10px rgba(0,0,0,0.2);
            position: relative; flex-shrink: 0;
            touch-action: none;
        }

        #board {
            display: grid;
            grid-template-columns: repeat(11, var(--cell-size));
            grid-template-rows: repeat(5, var(--cell-size));
            gap: 2px;
            z-index: 10;
        }

        #tray { 
            display: block;
            z-index: 9; 
        }

        .cell {
            width: var(--cell-size); height: var(--cell-size);
            background-color: var(--hole-color);
            border-radius: 50%;
            box-shadow: inset 1px 1px 4px rgba(0,0,0,0.6);
        }

        #joints-container {
            display: flex; justify-content: space-between;
            width: 90%; 
            height: 24px; 
            z-index: 5;
            margin-top: -6px; 
            margin-bottom: -6px;
            flex: 0 0 auto;
        }
        .joint {
            width: 24px; height: 100%;
            background: #151819; 
            border: 2px solid var(--border-color);
            border-radius: 4px;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.5);
        }

        #board-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.65);
            display: none; 
            flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 5000; border-radius: 8px;
            backdrop-filter: blur(2px);
            animation: fadeIn 0.3s ease-out;
        }
        #tray-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.65);
            display: none;
            z-index: 50; border-radius: 8px;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #board-message-box {
            background: transparent; 
            padding: 10px;
            text-align: center; 
            width: 100%;
            display: flex; flex-direction: column; align-items: center; gap: 15px;
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #board-message-box h2 {
            margin: 0; color: #ffffff;
            font-size: 1.6rem; line-height: 1.4;
            word-break: keep-all; font-family: 'Gowun Dodum', sans-serif;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        #board-message-box p {
            margin: 0; color: #ecf0f1; font-size: 1rem;
            text-shadow: 0 1px 5px rgba(0,0,0,0.5);
        }
        
        .btn-restart {
            padding: 12px 30px; font-size: 1.2rem; background: #6ab04c; color: white;
            border: none; border-radius: 50px; cursor: pointer; font-weight: bold;
            box-shadow: 0 5px 15px rgba(106, 176, 76, 0.4);
            animation: pulse 1.5s infinite;
            font-family: 'Gowun Dodum', sans-serif;
            margin-top: 5px;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .piece {
            display: grid; gap: 1px;
            cursor: grab; touch-action: none; z-index: 100;
            transition: transform 0.1s; 
            pointer-events: none; 
            isolation: isolate; 
        }
        .piece.on-board { position: absolute; gap: 2px; }
        .piece.in-tray { position: absolute; transform: scale(0.9); }
        .piece.picked-up {
            position: fixed; cursor: grabbing;
            opacity: 0.95; filter: drop-shadow(0 20px 30px rgba(0,0,0,0.4)); 
            transform: scale(1.05); pointer-events: none; z-index: 9999;
            gap: 2px; transition: none; 
        }
        .piece.locked { cursor: not-allowed; pointer-events: none; }
        
        .block {
            width: var(--cell-size); height: var(--cell-size);
            position: relative; 
            border-radius: 50%;
            pointer-events: auto; 
        }
        
        .visual-atom {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 50%;
            z-index: 2; 
            background-image: 
                radial-gradient(circle at 35% 35%, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 45%),
                radial-gradient(circle at 65% 65%, rgba(0,0,0,0) 50%, rgba(0,0,0,0.2) 100%);
            box-shadow: 
                inset -3px -3px 6px rgba(0,0,0,0.25),
                inset 2px 2px 4px rgba(255,255,255,0.2),
                1px 2px 4px rgba(0,0,0,0.25); 
        }

        .connector-h, .connector-v {
            position: absolute;
            background-color: inherit; 
            z-index: 1; 
            box-shadow: inset 0 0 4px rgba(0,0,0,0.3); 
            filter: brightness(0.85); 
        }
        .connector-h {
            top: 50%; left: 50%;
            width: calc(100% + 4px); 
            height: 40%; 
            transform: translateY(-50%);
        }
        .connector-v {
            top: 50%; left: 50%;
            height: calc(100% + 4px); 
            width: 40%; 
            transform: translateX(-50%);
        }
        
        .piece.locked .visual-atom {
            filter: brightness(0.8) grayscale(0.2);
            background-image: 
                repeating-linear-gradient(
                    45deg,
                    rgba(255,255,255,0.15),
                    rgba(255,255,255,0.15) 8px, 
                    transparent 8px,
                    transparent 16px
                ),
                radial-gradient(circle at 30% 30%, rgba(255,255,255,0.15), rgba(255,255,255,0) 40%);
        }

        #p-5.locked .visual-atom {
            filter: brightness(0.8);
            background-image: 
                repeating-linear-gradient(
                    45deg,
                    rgba(0,0,0,0.1),
                    rgba(0,0,0,0.1) 8px,
                    transparent 8px,
                    transparent 16px
                ),
                radial-gradient(circle at 30% 30%, rgba(255,255,255,0.15), rgba(255,255,255,0) 40%);
        }

        .piece.locked .connector-h, .piece.locked .connector-v {
            filter: brightness(0.8) grayscale(0.4);
        }

        .ghost-piece {
            position: absolute; display: grid; gap: 2px;
            pointer-events: none; z-index: 50; opacity: 0.3;
            transition: left 0.05s, top 0.05s;
        }
        .ghost-block {
            width: var(--cell-size); height: var(--cell-size);
            border-radius: 50%;
            background-color: white;
            border: 2px dashed rgba(255,255,255,0.9);
            box-shadow: 0 0 5px rgba(255,255,255,0.5);
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); z-index: 6000;
            display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px);
        }
        .modal {
            background: var(--modal-bg); color: var(--modal-text);
            padding: 25px; border-radius: 8px;
            max-width: 300px; width: 85%; text-align: left;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            animation: popIn 0.2s ease-out; border: 1px solid #444;
        }
        .modal h3 { margin: 0 0 15px; color: #fff; text-align: center; border-bottom: 1px solid #444; padding-bottom: 10px;}
        .modal-btn-group { display: flex; gap: 10px; justify-content: center; }
        .modal-btn-group button { 
            flex: 1; padding: 10px; border-radius: 6px; border: none; 
            font-weight: bold; cursor: pointer; font-size: 1rem; 
            font-family: 'Gowun Dodum', sans-serif;
        }
        .btn-yes { background: var(--secondary-btn); color: white; }
        .btn-no { background: #4a4a4a; color: #ecf0f1; }
        .modal button.close-btn { margin-top: 15px; background: #4a4a4a; width: 100%; border-radius: 6px; padding: 10px; color: white; border: none; font-weight: bold; cursor: pointer; font-family: 'Gowun Dodum', sans-serif;}
        #helpModal ul { padding-left: 0; list-style: none; color: #ccc; margin: 0; font-size: 0.9rem;}
        #helpModal li { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 5px 0;}
        
        #message {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(45, 52, 54, 0.95); color: white;
            padding: 15px 30px; border-radius: 50px;
            display: none; z-index: 7000; text-align: center;
            font-weight: 800; font-size: 1.1rem;
            pointer-events: none;
        }
    </style>
</head>
<body>
<header>
    <button class="btn-challenger" onclick="confirmChallenger()">â±ï¸</button>
    
    <div id="timer-container" style="display:none;">
        <div id="game-timer">00:00:00</div>
        <div id="best-record">BEST 00:00:00</div>
    </div>

    <h1>
        <img src="https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Grinning%20cat/3D/grinning_cat_3d.png" alt="Cat" class="title-icon">
        CATNOODLE
        <img src="https://raw.githubusercontent.com/microsoft/fluentui-emoji/main/assets/Puzzle%20piece/3D/puzzle_piece_3d.png" alt="Puzzle" class="title-icon">
    </h1>
    <button class="btn-help" onclick="openHelp()">?</button>
    <button class="btn-qr" onclick="openQR()">QR</button>
</header>

<div class="controls">
<select id="difficulty">
    <option value="2">2ê°œ</option>
    <option value="4">4ê°œ</option>
    <option value="half" selected>ë°˜ëƒ¥</option> 
    <option value="novice">ì´ˆë³´ëƒ¥</option>
</select>
    <button class="game-btn btn-gen" onclick="confirmNewGame()">ìƒì„±</button>
    <button class="game-btn btn-reset" onclick="confirmReset()">ì´ˆê¸°í™”</button>
    <button class="game-btn btn-answer" onclick="confirmShowAnswer()">ì •ë‹µ</button>
</div>

<div id="game-unit">
    <div id="board" class="game-panel">
        <div id="ghost" class="ghost-piece" style="display:none;"></div>
        
        <div id="board-overlay">
            <div id="board-message-box">
                <h2>ëƒ¥ëˆ„ë“¤ ë§ˆìŠ¤í„°!</h2>
                <p>í¼ì¦ì„ ì™„ì„±í–ˆì–´ìš”ğŸ‰</p>
                <button class="btn-restart" onclick="executeNewGame()">ìƒˆ ê²Œì„ ì‹œì‘</button>
            </div>
        </div>
    </div>
    
    <div id="joints-container">
        <div class="joint"></div>
        <div class="joint"></div>
    </div>

    <div id="tray" class="game-panel">
        <div id="tray-overlay"></div>
    </div>
</div>

<div class="modal-overlay" id="diffChangeModal" onclick="cancelDiffChange()">
    <div class="modal" onclick="event.stopPropagation()">
        <h3>ë‚œì´ë„ ë³€ê²½ âš ï¸</h3>
        <p style="text-align:center; color:#ddd; margin: 20px 0; line-height: 1.5;">
            ë‚œì´ë„ë¥¼ ë³€ê²½í•˜ë©´<br>
            <span style="color:#ff7675; font-weight:bold;">ìµœê³  ê¸°ë¡</span>ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.<br>
            ì§„í–‰í• ê¹Œìš”?
        </p>
        <div class="modal-btn-group">
            <button class="btn-no" onclick="cancelDiffChange()">ì•„ë‹ˆì˜¤</button>
            <button class="btn-yes" onclick="executeDiffChange()">ì˜ˆ</button>
        </div>
    </div>
</div>
    
<div class="modal-overlay" id="challengerModal" onclick="closeChallenger()">
    <div class="modal" onclick="event.stopPropagation()">
        <h3>ë„ì „ì ëª¨ë“œ ğŸ”¥</h3>
        <p style="text-align:center; color:#ddd; margin: 20px 0; line-height: 1.5;">
            í˜„ì¬ í¼ì¦ì„ ì´ˆê¸°í™”í•˜ê³ <br>
            <span style="color:#ff7675; font-weight:bold;">íƒ€ì´ë¨¸</span>ë¥¼ ì¼¤ê¹Œìš”?
        </p>
        <div class="modal-btn-group">
            <button class="btn-no" onclick="closeChallenger()">ì•„ë‹ˆì˜¤</button>
            <button class="btn-yes" onclick="executeChallenger()">ì˜ˆ</button>
        </div>
    </div>
</div>

    <div class="modal-overlay" id="stopChallengerModal" onclick="closeStopChallenger()">
    <div class="modal" onclick="event.stopPropagation()">
        <h3>ë„ì „ ì¤‘ë‹¨</h3>
        <p style="text-align:center; color:#ddd; margin: 20px 0; line-height: 1.5;">
            ë„ì „ì ëª¨ë“œë¥¼ ì¢…ë£Œí•˜ê³ <br>ì¼ë°˜ ëª¨ë“œë¡œ ëŒì•„ê°ˆê¹Œìš”?
        </p>
        <div class="modal-btn-group">
            <button class="btn-no" onclick="closeStopChallenger()">ì•„ë‹ˆì˜¤</button>
            <button class="btn-yes" onclick="executeStopChallenger()">ì˜ˆ</button>
        </div>
    </div>
</div>
    
<div class="modal-overlay" id="helpModal" onclick="closeHelp()">
    <div class="modal" onclick="event.stopPropagation()">
        <h3>ì¡°ì‘ ë°©ë²•</h3>
        <ul>
            <li><span>ì¡°ê° ë“¤ê¸°</span> <span class="key">í´ë¦­ / ë“œë˜ê·¸</span></li>
            <li><span>ë’¤ì§‘ê¸°</span> <span class="key">ìš°í´ë¦­ / íƒ­</span></li>
            <li><span>íšŒì „</span> <span class="key">íœ  / ë“œë˜ê·¸+ë¹ˆ í™”ë©´ í„°ì¹˜</span></li>
        </ul>
        
<p style="font-size: 0.75rem; color: #888; margin-top: 15px; border-top: 1px solid #333; padding-top: 10px; line-height: 1.4; text-align: center;">
    Educational Insightsì˜ í¼ì¦ ê²Œì„ <br>
    <i>Kanoodle</i>ì„ ì˜¤ë§ˆì£¼í•œ íŒ¬ ë©”ì´ë“œ ì›¹ ì•±ì…ë‹ˆë‹¤. <br><br>
    Â© 2026. 3arch2nd. All rights reserved.
</p>
        <button class="close-btn" onclick="closeHelp()">ë‹«ê¸°</button>
    </div>
</div>

<div class="modal-overlay" id="answerModal" onclick="closeAnswer()">
    <div class="modal" onclick="event.stopPropagation()">
        <h3>ì •ë‹µ í™•ì¸</h3>
        <p style="text-align:center; color:#ddd; margin: 20px 0;">í˜„ì¬ ì§„í–‰ ìƒí™©ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤.<br>ì •ë‹µì„ ë³´ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <div class="modal-btn-group">
            <button class="btn-no" onclick="closeAnswer()">ì•„ë‹ˆì˜¤</button>
            <button class="btn-yes" onclick="executeShowAnswer()">ì˜ˆ</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="qrModal" onclick="closeQR()">
    <div class="qr-modal-content" onclick="event.stopPropagation()">
        <button class="close-x-btn" onclick="closeQR()">&times;</button>
        
        <h3 style="margin:0; border:none; color:white;">Scan Me!</h3>
        
        <img id="qr-image" src="" alt="QR Code" style="width: 140px; height: 140px; border-radius: 8px; border: 4px solid white;">
        
        <p style="margin:0; font-size: 0.85rem; color:#aaa;">ì¹´ë©”ë¼ë¡œ ìŠ¤ìº”í•´ ì ‘ì†í•˜ì„¸ìš”</p>
        
        </div>
</div>
    
<div class="modal-overlay" id="resetModal" onclick="closeReset()">
    <div class="modal" onclick="event.stopPropagation()">
        <h3>ì´ˆê¸°í™”</h3>
        <p style="text-align:center; color:#ddd; margin: 20px 0;">ëª¨ë“  ì¡°ê°ì„<br>ëª¨ìŒíŒìœ¼ë¡œ ë˜ëŒë¦´ê¹Œìš”?</p>
        <div class="modal-btn-group">
            <button class="btn-no" onclick="closeReset()">ì•„ë‹ˆì˜¤</button>
            <button class="btn-yes" onclick="executeReset()">ì˜ˆ</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="genModal" onclick="closeGen()">
    <div class="modal" onclick="event.stopPropagation()">
        <h3>ìƒˆ ê²Œì„</h3>
        <p id="gen-message" style="text-align:center; color:#ddd; margin: 20px 0; line-height: 1.6;">
        </p>
        <div class="modal-btn-group">
            <button class="btn-no" onclick="closeGen()">ì•„ë‹ˆì˜¤</button>
            <button class="btn-yes" onclick="executeNewGame()">ì˜ˆ</button>
        </div>
    </div>
</div>

<div id="message"></div>

<script src="problems.js"></script>

<script>
document.addEventListener('contextmenu', event => event.preventDefault());

const SHAPES_DEF = [
    { id: 0, color: '#ff8a00', shape: [[1,0],[1,0],[1,1]] }, 
    { id: 1, color: '#f44336', shape: [[1,1],[1,1],[0,1]] }, 
    { id: 2, color: '#005db0', shape: [[1,1,1,1],[1,0,0,0]] }, 
    { id: 3, color: '#ffcccc', shape: [[0,1],[0,1],[1,1],[0,1]] }, 
    { id: 4, color: '#009f07', shape: [[1,1],[1,1],[0,1]] }, 
    { id: 5, color: '#f3f6f4', shape: [[1,1],[0,1]] }, 
    { id: 6, color: '#88ddf0', shape: [[1,0,0],[1,0,0],[1,1,1]] }, 
    { id: 7, color: '#ff76a7', shape: [[1,0,0],[1,1,0],[0,1,1]] }, 
    { id: 8, color: '#ffdd57', shape: [[1,0,1],[1,1,1]] }, 
    { id: 9, color: '#8e44ad', shape: [[1],[1],[1],[1]] }, 
    { id: 10, color: '#baf776', shape: [[1,1],[1,1]] }, 
    { id: 11, color: '#bfbfbf', shape: [[0,1,0],[1,1,1],[0,1,0]] } 
];

/* * SOLUTION_DB is loaded from problems.js */

const COLS = 11;
const ROWS = 5;
let cellSize = 32;
let boardState = [];
let answerKey = [];
let pieces = [];
let pickedPieceIdx = null;
let dragOffsetX = 0;
let dragOffsetY = 0;
let isDragging = false;
let startX = 0;
let startY = 0;

let dragStartGridX = -1;
let dragStartGridY = -1;
let lastValidGhostPos = null; 
let globalZIndex = 100;

let hasRotated = false; 
let currentProblemIdx = -1;

// ğŸ² [ì¶”ê°€] ì…”í”Œ ë¡œì§ì„ ìœ„í•œ ì „ì—­ ë³€ìˆ˜
let puzzleDeck = [];

    // ê¸°ì¡´ ë³€ìˆ˜ë“¤ ì•„ë˜ì— ì¶”ê°€
let timerInterval = null;
let startTime = 0;
let isChallengerMode = false;
// ê¸°ì¡´ ë³€ìˆ˜ ì•„ë˜ì— ì¶”ê°€
let bestTime = Infinity; // ì´ˆê¸°ê°’ì€ ë¬´í•œëŒ€ (ê¸°ë¡ ì—†ìŒ)
let currentDifficultyMode = 'half';
let pendingDifficulty = '';      // ë³€ê²½ ëŒ€ê¸° ì¤‘ì¸ ë‚œì´ë„
    
const boardEl = document.getElementById('board');
const trayEl = document.getElementById('tray');
const gameUnitEl = document.getElementById('game-unit');
const trayOverlay = document.getElementById('tray-overlay');
const boardOverlay = document.getElementById('board-overlay'); 
const ghostEl = document.getElementById('ghost');

// ğŸ†• ëª¨ë‹¬ ì œì–´ í•¨ìˆ˜
function closeStopChallenger() {
    document.getElementById('stopChallengerModal').style.display = 'none';
}
function executeStopChallenger() {
    closeStopChallenger();
    stopChallenger(); // ì‹¤ì œ ì¢…ë£Œ í•¨ìˆ˜ í˜¸ì¶œ
}

// ê¸°ì¡´ confirmChallenger ìˆ˜ì •
function confirmChallenger() {
    if (isChallengerMode) {
        // ğŸ†• íŒì—… ëŒ€ì‹  ëª¨ë‹¬ ë„ìš°ê¸°
        document.getElementById('stopChallengerModal').style.display = 'flex';
    } else {
        document.getElementById('challengerModal').style.display = 'flex';
    }
}

    // ğŸ‘‡ [ëˆ„ë½ëœ í•¨ìˆ˜ë“¤ ì¶”ê°€] ì´ ì½”ë“œë¥¼ confirmChallenger ê·¼ì²˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.

function closeChallenger() {
    document.getElementById('challengerModal').style.display = 'none';
}

function closeStopChallenger() {
    document.getElementById('stopChallengerModal').style.display = 'none';
}

function executeStopChallenger() {
    closeStopChallenger();
    stopChallenger(); // ì‹¤ì œ ì¢…ë£Œ ë¡œì§ ì‹¤í–‰
}

// (ì°¸ê³ ) ìŠ¹ë¦¬ ì‹œ ì†Œë¦¬ ì¬ìƒ í•¨ìˆ˜ë„ ì—†ì–´ì„œ ì˜¤ë¥˜ê°€ ë‚  ìˆ˜ ìˆìœ¼ë‹ˆ ë¹ˆ í•¨ìˆ˜ë¡œ ì¶”ê°€í•´ë‘¡ë‹ˆë‹¤.
function playSound(type) {
    console.log("Sound played:", type); 
}

// íƒ€ì´ë¨¸ ì‹œì‘ ì‹œ display ì†ì„± ìˆ˜ì • (block -> flex)
function executeChallenger() {
    closeChallenger();
    isChallengerMode = true;
    document.querySelector('.btn-challenger').innerText = 'ğŸ±';
    
    // ğŸ’¡ flexë¡œ ë³´ì—¬ì•¼ ëª¨ë°”ì¼ ì •ë ¬ì´ ì˜ˆì©ë‹ˆë‹¤
    document.getElementById('timer-container').style.display = 'flex'; 
    
    loadNewGameLogic(); 
    startTimerLogic(); 
    showMessage("ë„ì „ì ëª¨ë“œ ğŸ”¥");
}

// íƒ€ì´ë¨¸ ì¢…ë£Œ ì‹œ (ë„ì „ì -> ì¼ë°˜ ëª¨ë“œ ì „í™˜)
function stopChallenger() {
    isChallengerMode = false;
    document.querySelector('.btn-challenger').innerText = 'â±ï¸';
    stopTimer();
    
    // íƒ€ì´ë¨¸ UI ìˆ¨ê¸°ê¸°
    document.getElementById('timer-container').style.display = 'none'; 
    
    // ğŸ›‘ [ìˆ˜ì •] ì•„ë˜ ì¤„ì„ ì‚­ì œí•˜ê±°ë‚˜ ì£¼ì„ ì²˜ë¦¬í•˜ì—¬ í˜„ì¬ í¼ì¦ì„ ìœ ì§€í•©ë‹ˆë‹¤!
    // loadNewGameLogic(); 
    
    showMessage("ì¼ë°˜ ëª¨ë“œ ğŸ˜º");
}

// (íƒ€ì´ë¨¸ ì‹œì‘ ë¡œì§ì„ ë³„ë„ í•¨ìˆ˜ë¡œ ë¶„ë¦¬í•˜ë©´ ì¬ì‚¬ìš©í•˜ê¸° ì¢‹ìŠµë‹ˆë‹¤)
function startTimerLogic() {
    stopTimer();
    startTime = Date.now();
    timerInterval = setInterval(updateTimer, 10);
}

function updateTimer() {
    const now = Date.now();
    const diff = now - startTime;
    
    const m = Math.floor(diff / 60000);
    const s = Math.floor((diff % 60000) / 1000);
    const ms = Math.floor((diff % 1000) / 10);
    
    // âœ… ì¤‘ì•™ íƒ€ì´ë¨¸ ìˆ«ìë§Œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
    document.getElementById('game-timer').innerText = 
        `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}:${String(ms).padStart(2,'0')}`;
}

function stopTimer() {
    if(timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
}
// ğŸŒ IT ì§€ì‹: window.location.hrefëŠ” í˜„ì¬ ë¸Œë¼ìš°ì €ì˜ ì£¼ì†Œì°½ ë‚´ìš©ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
// qrserver.com APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.

    function openQR() {
        const url = window.location.href;
        document.getElementById('qr-image').src = 
            `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(url)}`;
        document.getElementById('qrModal').style.display = 'flex';
    }
    function closeQR() {
        document.getElementById('qrModal').style.display = 'none';
    }
    
// Functions
function openHelp() { document.getElementById('helpModal').style.display = 'flex'; }
function closeHelp() { document.getElementById('helpModal').style.display = 'none'; }
function confirmShowAnswer() { document.getElementById('answerModal').style.display = 'flex'; }
function closeAnswer() { document.getElementById('answerModal').style.display = 'none'; }
function confirmReset() { document.getElementById('resetModal').style.display = 'flex'; }
function closeReset() { document.getElementById('resetModal').style.display = 'none'; }

// ğŸ†• [ìƒì„±] ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜ (í•µì‹¬ ë¡œì§ ë³€ê²½)
function confirmNewGame() { 
    const selectedVal = document.getElementById('difficulty').value;
    
    // 1. ë„ì „ì ëª¨ë“œì¸ë°, ë‚œì´ë„ë¥¼ ë³€ê²½í•˜ë ¤ê³  ì‹œë„í•œ ê²½ìš° -> âš ï¸ ê²½ê³  ëª¨ë‹¬ ë„ì›€
    if (isChallengerMode && selectedVal !== currentDifficultyMode) {
        pendingDifficulty = selectedVal; // ë³€ê²½í•˜ë ¤ëŠ” ê°’ ì„ì‹œ ì €ì¥
        document.getElementById('diffChangeModal').style.display = 'flex';
        return; // ì—¬ê¸°ì„œ ì¤‘ë‹¨ (ê¸°ì¡´ ìƒˆ ê²Œì„ ëª¨ë‹¬ ì•ˆ ë„ì›€)
    }

    // 2. ê·¸ ì™¸(ì¼ë°˜ ëª¨ë“œê±°ë‚˜ ë‚œì´ë„ ë³€ê²½ ì—†ìŒ) -> âœ… ê¸°ì¡´ ìƒˆ ê²Œì„ ë¡œì§ ì§„í–‰
    showGenModal(selectedVal);
}


// ğŸ“Œ ê¸°ì¡´ confirmNewGameì˜ ë’·ë¶€ë¶„ì„ ë³„ë„ í•¨ìˆ˜ë¡œ ë¶„ë¦¬ (ì¬ì‚¬ìš© ëª©ì )
function showGenModal(val) {
    const msgEl = document.getElementById('gen-message');
    const highlightStyle = 'color:var(--reset-btn); font-weight:bold;';

    if (val === 'novice') {
        msgEl.innerHTML = `<span style="${highlightStyle}">ì´ˆë³´ëƒ¥</span> ëª¨ë“œë¡œ<br>9ê°œì˜ ì¡°ê°ì„ ë¯¸ë¦¬ ë§ì¶”ê³ <br>ë‚¨ì€ 3ê°œë§Œ í’€ì–´ë³¼ê¹Œìš”?`;
    } else if (val === 'half') {
        msgEl.innerHTML = `<span style="${highlightStyle}">ë°˜ëƒ¥</span> ëª¨ë“œë¡œ<br>6ê°œì˜ ì¡°ê°ì„ ì™¼ìª½ì— ë°°ì—´í•˜ì—¬<br>ìƒˆ ê²Œì„ì„ ì‹œì‘í• ê¹Œìš”?`;
    } else {
        msgEl.innerHTML = `<span style="${highlightStyle}">ëœë¤ ${val}ê°œ</span> ê³ ì •ìœ¼ë¡œ<br>ìƒˆë¡œìš´ ê²Œì„ì„ ë§Œë“¤ê¹Œìš”?`;
    }
    
    document.getElementById('genModal').style.display = 'flex'; 
}

// âš ï¸ ê²½ê³  ëª¨ë‹¬: ì˜ˆ (ë³€ê²½ í™•ì • ë° ê²Œì„ ì‹œì‘)
function executeDiffChange() {
    document.getElementById('diffChangeModal').style.display = 'none';
    
    // 1. ë‚œì´ë„ ë³€ê²½ ì ìš©
    currentDifficultyMode = pendingDifficulty;
    
    // 2. ê¸°ë¡ ì´ˆê¸°í™” ë° ë¼ë²¨ ì—…ë°ì´íŠ¸
    bestTime = Infinity;
    updateBestRecordLabel();
    saveDifficulty();
    
    showMessage("ë‚œì´ë„ ë³€ê²½! ê¸°ë¡ ì´ˆê¸°í™”");

    // 3. ë°”ë¡œ ê²Œì„ ìƒì„± ì‹¤í–‰ (ë‹¤ì‹œ ë¬»ì§€ ì•Šê³  ë°”ë¡œ ì‹œì‘)
    executeNewGame(); 
}

// âš ï¸ ê²½ê³  ëª¨ë‹¬: ì•„ë‹ˆì˜¤ (ì·¨ì†Œ)
function cancelDiffChange() {
    document.getElementById('diffChangeModal').style.display = 'none';
    
    // ì„ íƒì„ ì·¨ì†Œí–ˆìœ¼ë¯€ë¡œ, ë“œë¡­ë‹¤ìš´ì„ ë‹¤ì‹œ ì›ë˜(í˜„ì¬ í”Œë ˆì´ ì¤‘ì¸) ë‚œì´ë„ë¡œ ë˜ëŒë¦¼
    document.getElementById('difficulty').value = currentDifficultyMode;
}
    
function closeGen() { document.getElementById('genModal').style.display = 'none'; }

function executeShowAnswer() {
    closeAnswer();
    
    // ğŸ›‘ íƒ€ì´ë¨¸ ì •ì§€ ë° ì´ˆê¸°í™”
    if (isChallengerMode) {
        stopTimer();
        document.getElementById('game-timer').innerText = "00:00:00";
    }
    
    // ğŸ”’ [ìˆ˜ì •] ì´ˆê¸°í™” ë²„íŠ¼ê³¼ ì •ë‹µ ë²„íŠ¼ì„ ëª¨ë‘ ë¹„í™œì„±í™”(ì ê¸ˆ)
    document.querySelector('.btn-reset').disabled = true;
    document.querySelector('.btn-answer').disabled = true;

    // ê¸°ì¡´ ì •ë‹µ ë¡œì§
    boardState = JSON.parse(JSON.stringify(answerKey));
    extractPiecesFromBoard(); 
    renderPieces();
}

function executeReset() {
    closeReset();
    pieces.forEach(p => {
        if (!p.isLocked && p.x !== -1) {
            removePieceFromBoardState(p.currentShape, p.y, p.x);
            p.x = -1; p.y = -1;
        }
    });
    randomizeTrayPositions();
    renderPieces();
    boardOverlay.style.display = 'none';
    trayOverlay.style.display = 'none';
    showMessage("ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!");
}

function executeNewGame() {
    closeGen();
    loadNewGameLogic();
}

// ğŸ†• ë‚œì´ë„ ë¼ë²¨ì„ ë°˜í™˜í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
function getModeTitle(val) {
    const map = {
        '2': '2ê°œ',
        '4': '4ê°œ',
        'half': 'ë°˜ëƒ¥',
        'novice': 'ì´ˆë³´ëƒ¥'
    };
    return map[val] || 'BEST';
}
    
// ì´ í•¨ìˆ˜ê°€ ì´ë¯¸ innerHTMLì„ ì‚¬ìš©í•˜ê³  ìˆìœ¼ë¯€ë¡œ, 
// ê¸°ë¡ì´ ë°”ë€” ë• í•­ìƒ ì´ í•¨ìˆ˜ë¥¼ ë¶€ë¥´ê±°ë‚˜ ì´ í˜•ì‹ì„ ë”°ë¼ì•¼ í•©ë‹ˆë‹¤.
function updateBestRecordLabel() {
    const title = getModeTitle(currentDifficultyMode);
    const timeStr = (bestTime === Infinity) ? "00:00:00" : msToTime(bestTime);
    
    document.getElementById('best-record').innerHTML = 
        `<span class="best-txt">${title}</span><span class="best-time">${timeStr}</span>`;
}

// ğŸ†• ì‹œê°„ í¬ë§·íŒ… í—¬í¼ (ê¸°ì¡´ ì½”ë“œ ì¬ì‚¬ìš©ì„ ìœ„í•´ ë¶„ë¦¬)
function msToTime(duration) {
    const m = Math.floor(duration / 60000);
    const s = Math.floor((duration % 60000) / 1000);
    const ms = Math.floor((duration % 1000) / 10);
    return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}:${String(ms).padStart(2,'0')}`;
}

// ğŸ’¾ (ê¸°ì¡´ í•¨ìˆ˜ ìœ ì§€í•˜ë˜ ë‚´ìš© í™•ì¸)
function saveDifficulty() {
    const val = document.getElementById('difficulty').value;
    localStorage.setItem('catnoodle_difficulty', val);
}

function loadDifficultySetting() {
    const saved = localStorage.getItem('catnoodle_difficulty');
    const select = document.getElementById('difficulty');
    
    if (saved && select.querySelector(`option[value="${saved}"]`)) {
        select.value = saved;
        currentDifficultyMode = saved; // ì €ì¥ëœ ê°’ìœ¼ë¡œ ë™ê¸°í™”
    } else {
        // ì €ì¥ëœ ê²Œ ì—†ìœ¼ë©´ í˜„ì¬ ì„ íƒëœ ê°’(ê¸°ë³¸ê°’)ìœ¼ë¡œ ë™ê¸°í™”
        currentDifficultyMode = select.value; 
    }
    
    // í™”ë©´ì— í…ìŠ¤íŠ¸ ë°˜ì˜ (2ê°œ 00:00:00 ë“±)
    updateBestRecordLabel(); 
}

// ì´ˆê¸°í™” ìˆœì„œì— ë¡œë“œ í•¨ìˆ˜ ì¶”ê°€
window.addEventListener('resize', initLayout);
loadDifficultySetting(); // ğŸ’¡ ê²Œì„ ì‹œì‘ ì „ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
initLayout();
loadNewGame();
    
function initLayout() {
    const headerH = document.querySelector('header').offsetHeight;
    const controlsH = document.querySelector('.controls').offsetHeight;
    const jointsH = 24; 
    const margin = 120; 
    
    const availableH = window.innerHeight - headerH - controlsH - jointsH - margin;
    
    const isDesktop = window.innerWidth > 700;
    const sideMargin = isDesktop ? 160 : 40; 
    const availableW = window.innerWidth - sideMargin;

    const logicalRows = 10.5; 
    const logicalCols = 11;

    const sizeByWidth = Math.floor((availableW - 30) / logicalCols);
    const sizeByHeight = Math.floor(availableH / logicalRows);

    cellSize = Math.min(sizeByWidth, sizeByHeight);
    if(cellSize < 20) cellSize = 20; 
    if(cellSize > 50) cellSize = 50;

    document.documentElement.style.setProperty('--cell-size', `${cellSize}px`);
    
    const boardInnerW = (11 * cellSize) + (10 * 2); 
    const totalW = boardInnerW + 20 + 8; 
    gameUnitEl.style.width = `${totalW}px`;

    const boardInnerH = (5 * cellSize) + (4 * 2); 
    const totalH = boardInnerH + 28; 
    trayEl.style.height = `${totalH}px`;

    createGrid();
    if(pieces.length > 0) {
        constrainTrayPieces();
        renderPieces();
    }
}

function constrainTrayPieces() {
    const trayW = trayEl.clientWidth;
    const trayH = trayEl.clientHeight;
    
    pieces.forEach(p => {
        if (p.x === -1) { 
            const pW = p.currentShape[0].length * cellSize;
            const pH = p.currentShape.length * cellSize;
            
            p.trayX = Math.max(10, Math.min(p.trayX, trayW - pW - 10));
            p.trayY = Math.max(10, Math.min(p.trayY, trayH - pH - 10));
        }
    });
}

function createGrid() {
    boardEl.innerHTML = '';
    for(let i=0; i<ROWS*COLS; i++) {
        const div = document.createElement('div');
        div.className = 'cell';
        boardEl.appendChild(div);
    }
    boardEl.appendChild(ghostEl);
    
    const overlayDiv = document.createElement('div');
    overlayDiv.id = 'board-overlay';
    overlayDiv.innerHTML = `
        <div id="board-message-box">
            <h2>ëƒ¥ëˆ„ë“¤ ë§ˆìŠ¤í„°!</h2>
            <p>í¼ì¦ì„ ì™„ì„±í–ˆì–´ìš”ğŸ‰</p>
            <button class="btn-restart" onclick="executeNewGame()">ìƒˆ ê²Œì„ ì‹œì‘</button>
        </div>
    `;
    boardEl.appendChild(overlayDiv);
}

function loadNewGame() {
    loadNewGameLogic();
}

function loadNewGameLogic() {
    // ğŸ”“ [ìˆ˜ì •] ìƒˆ ê²Œì„ ì‹œì‘ ì‹œ ë²„íŠ¼ë“¤ ë‹¤ì‹œ í™œì„±í™”
    document.querySelector('.btn-reset').disabled = false;
    document.querySelector('.btn-answer').disabled = false;

    if (isChallengerMode) {
        startTimerLogic(); 
        document.getElementById('timer-container').style.display = 'flex'; 
    } else {
        stopTimer();
        document.getElementById('timer-container').style.display = 'none';
    }
    if(pickedPieceIdx !== null) releasePiece();
    trayOverlay.style.display = 'none';
    const bOverlay = document.getElementById('board-overlay');
    if(bOverlay) bOverlay.style.display = 'none';
    
    let newIdx = 0;

    if (typeof SOLUTION_DB !== 'undefined' && SOLUTION_DB.length > 0) {
        // 1. ë±ì´ ë¹„ì–´ìˆê±°ë‚˜ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ìƒˆë¡œ ë§Œë“­ë‹ˆë‹¤. (All Reset)
        if (puzzleDeck.length === 0) {
            console.log("ğŸ”€ ëª¨ë“  ë¬¸ì œë¥¼ í’€ì—ˆìŠµë‹ˆë‹¤! ì¹´ë“œë¥¼ ë‹¤ì‹œ ì„ìŠµë‹ˆë‹¤...");
            // 0ë¶€í„° DB ê¸¸ì´-1 ê¹Œì§€ì˜ ìˆ«ìë¥¼ ì±„ì›Œë„£ìŒ
            puzzleDeck = Array.from({length: SOLUTION_DB.length}, (_, i) => i);
        }

        // 2. ë±ì—ì„œ ë¬´ì‘ìœ„ë¡œ ì¹´ë“œ í•œ ì¥ì„ ë½‘ìŠµë‹ˆë‹¤. (Pop Random)
        const randomIndex = Math.floor(Math.random() * puzzleDeck.length);
        newIdx = puzzleDeck[randomIndex];
        
        // 3. ë½‘ì€ ì¹´ë“œëŠ” ë±ì—ì„œ ì œê±°í•©ë‹ˆë‹¤. (ì¤‘ë³µ ë°©ì§€ í•µì‹¬)
        puzzleDeck.splice(randomIndex, 1);

        // í˜„ì¬ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸ (ì¹˜íŠ¸í‚¤ ë“± í˜¸í™˜ì„± ìœ ì§€)
        currentProblemIdx = newIdx;

        if (SOLUTION_DB[newIdx].id) {
            console.log(`%cğŸ² ëœë¤ ì¶œì œ: #${SOLUTION_DB[newIdx].id} (ë‚¨ì€ ë¬¸ì œ: ${puzzleDeck.length}ê°œ)`, "background: #2d3436; color: #badc58; font-size: 16px; font-weight: bold; padding: 6px; border-radius: 4px;");
        } else {
            console.log(`ğŸ² ëœë¤ ì¶œì œ Index: ${newIdx} (ë‚¨ì€ ë¬¸ì œ: ${puzzleDeck.length}ê°œ)`);
        }

        answerKey = JSON.parse(JSON.stringify(SOLUTION_DB[newIdx]));
    } else {
        // Fallback
        answerKey = [[7,7,4,4,4,1,1,1,6,6,6],[3,7,7,0,4,4,1,1,5,5,6],[3,3,7,0,0,0,11,8,8,5,6],[3,2,2,2,2,11,11,11,8,10,10],[3,2,9,9,9,9,11,8,8,10,10]];
        console.log("âš ï¸ ë°ì´í„°ë² ì´ìŠ¤ê°€ ë¡œë“œë˜ì§€ ì•Šì•„ ê¸°ë³¸ ë¬¸ì œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.");
    }

    boardState = JSON.parse(JSON.stringify(answerKey));
    extractPiecesFromBoard();
    applyDifficulty();
    
    globalZIndex = 100;
    pieces.forEach(p => p.zIndex = globalZIndex++);

    setTimeout(() => {
        randomizeTrayPositions();
        renderPieces();
    }, 50);
    
    showMessage("ìƒˆë¡œìš´ ê²Œì„ ì‹œì‘!"); 
}
function extractPiecesFromBoard() {
    pieces = [];
    for(let id=0; id<12; id++) {
        let coords = [];
        for(let r=0; r<ROWS; r++) {
            for(let c=0; c<COLS; c++) { if(boardState[r][c] === id) coords.push({r, c}); }
        }
        if(coords.length === 0) continue;
        const minR = Math.min(...coords.map(p=>p.r));
        const minC = Math.min(...coords.map(p=>p.c));
        const height = Math.max(...coords.map(p=>p.r)) - minR + 1;
        const width = Math.max(...coords.map(p=>p.c)) - minC + 1;
        let shape = Array(height).fill().map(()=>Array(width).fill(0));
        coords.forEach(p => { shape[p.r - minR][p.c - minC] = 1; });

        pieces.push({
            id: id, color: SHAPES_DEF[id].color, currentShape: shape,
            x: minC, y: minR, trayX: 0, trayY: 0, isLocked: true,
            zIndex: 100
        });
    }
}

function randomizeTrayPositions() {
    const trayW = trayEl.clientWidth || 300;
    const trayH = trayEl.clientHeight || 200;
    const trayPieces = pieces.filter(p => !p.isLocked && p.x === -1);
    
    let placedRects = [];

    trayPieces.forEach(p => {
        const pWidth = p.currentShape[0].length * cellSize;
        const pHeight = p.currentShape.length * cellSize;
        
        let bestX = 10, bestY = 10;
        let found = false;

        for(let i=0; i<50; i++) {
            const rx = Math.random() * (trayW - pWidth - 20);
            const ry = Math.random() * (trayH - pHeight - 20);
            
            let overlap = false;
            for(let rect of placedRects) {
                if(rx < rect.x + rect.w && rx + pWidth > rect.x &&
                   ry < rect.y + rect.h && ry + pHeight > rect.y) {
                    overlap = true;
                    break;
                }
            }
            if(!overlap) {
                bestX = Math.max(10, rx); bestY = Math.max(10, ry);
                found = true; break;
            }
        }
        
        if(!found) {
             bestX = Math.max(10, Math.random() * (trayW - pWidth - 20));
             bestY = Math.max(10, Math.random() * (trayH - pHeight - 20));
        }

        p.trayX = bestX; p.trayY = bestY;
        placedRects.push({x: bestX, y: bestY, w: pWidth, h: pHeight});
    });
}

function applyDifficulty() {
    const diffSelect = document.getElementById('difficulty');
    const val = diffSelect.value;
    
    // ğŸ’¾ [ì €ì¥] ì„ íƒí•œ ë‚œì´ë„ë¥¼ ë¸Œë¼ìš°ì €ì— ì €ì¥
    localStorage.setItem('catnoodle_difficulty', val);

    let allIndices = pieces.map((_, i) => i);
    let lockedIndices = [];

    // ğŸ’¡ ìˆ˜ì •ëœ ë¶€ë¶„: ë°˜ëƒ¥(half) ë˜ëŠ” ì´ˆë³´ëƒ¥(novice)ì¸ ê²½ìš°
    if (val === 'half' || val === 'novice') {
        // 1. í˜„ì¬ ì¡°ê°ë“¤ì˜ ìœ„ì¹˜ì™€ ì¸ë±ìŠ¤ë¥¼ ê°€ì ¸ì˜´
        let piecePositions = pieces.map((p, index) => ({ index: index, x: p.x }));
        
        // 2. xì¢Œí‘œ ê¸°ì¤€ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ (ì™¼ìª½ -> ì˜¤ë¥¸ìª½)
        piecePositions.sort((a, b) => a.x - b.x);
        
        // 3. ì ê¸€ ê°œìˆ˜ ê²°ì • (ì´ˆë³´ëƒ¥ì´ëŠ” 9ê°œ, ë°˜ëƒ¥ì´ëŠ” 6ê°œ)
        const lockCount = (val === 'novice') ? 9 : 6;
        
        // 4. ì•ì—ì„œë¶€í„° ê°œìˆ˜ë§Œí¼ ì˜ë¼ì„œ ì ê¸ˆ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
        lockedIndices = piecePositions.slice(0, lockCount).map(obj => obj.index);
        
    } else {
        // [ì¼ë°˜ ëª¨ë“œ] ë¬´ì‘ìœ„ Nê°œ ì ê¸ˆ
        const keepCount = parseInt(val);
        for(let i=0; i<keepCount; i++) {
            let r = Math.floor(Math.random() * allIndices.length);
            lockedIndices.push(allIndices[r]);
            allIndices.splice(r, 1);
        }
    }

// ì ê¸ˆ ìƒíƒœ ì ìš©
    pieces.forEach((p, idx) => {
        if(lockedIndices.includes(idx)) {
            p.isLocked = true;
        } else {
            p.isLocked = false;
            removePieceFromBoardState(p.currentShape, p.y, p.x);
            p.x = -1; p.y = -1;
            
            // ğŸ‘‡ [ì¶”ê°€] ëª¨ìŒíŒìœ¼ë¡œ ê°€ëŠ” ì¡°ê°ë“¤ì„ ë¬´ì‘ìœ„ë¡œ ë³€í˜•í•©ë‹ˆë‹¤!
            randomizePieceOrientation(idx);
        }
    });
}
    
function removePieceFromBoardState(shape, r, c) {
    for(let i=0; i<shape.length; i++) for(let j=0; j<shape[0].length; j++) if(shape[i][j]) boardState[r+i][c+j]=-1;
}

// âš ï¸ ë²„ê·¸ ìˆ˜ì •: íšŒì „ ì‹œ ì „ì²´ê°€ ì•„ë‹Œ í•´ë‹¹ ì¡°ê°ë§Œ ì—…ë°ì´íŠ¸
function updateVisualsInDrag(idx) {
    const p = pieces[idx];
    if(pickedPieceIdx === idx) {
        const el = document.getElementById(`p-${idx}`);
        // ìš”ì†Œ ì´ˆê¸°í™”
        el.style.gridTemplateColumns = `repeat(${p.currentShape[0].length}, 1fr)`;
        el.innerHTML = ''; 

        // ìƒˆ ëª¨ì–‘ìœ¼ë¡œ DOM ì¬ìƒì„±
        p.currentShape.forEach((row, r) => {
            row.forEach((v, c) => {
                const b = document.createElement('div');
                if(v) { 
                    b.className = 'block'; 
                    b.style.backgroundColor = p.color;
                    
                    const atom = document.createElement('div');
                    atom.className = 'visual-atom';
                    atom.style.backgroundColor = p.color;
                    b.appendChild(atom);

                    // ì—°ê²°ë¶€ ì¬ìƒì„±
                    if(c + 1 < row.length && row[c+1]) {
                        const h = document.createElement('div'); h.className = 'connector-h'; b.appendChild(h);
                    }
                    if(r + 1 < p.currentShape.length && p.currentShape[r+1][c]) {
                        const v = document.createElement('div'); v.className = 'connector-v'; b.appendChild(v);
                    }
                } else {
                    b.style.visibility = 'hidden';
                }
                el.appendChild(b);
            });
        });
        updateGhost(idx);
    } else {
        renderPieces();
    }
}

function renderPieces() {
    document.querySelectorAll('.piece').forEach(e => {
        if(pickedPieceIdx === null || e.id !== `p-${pickedPieceIdx}`) e.remove();
    });

    pieces.forEach((p, idx) => {
        if(pickedPieceIdx === idx && document.getElementById(`p-${idx}`)) return;

        const el = document.createElement('div');
        const isInTray = p.x === -1;
        el.className = `piece ${isInTray ? 'in-tray' : 'on-board'} ${p.isLocked?'locked':''}`;
        el.id = `p-${idx}`;
        el.style.gridTemplateColumns = `repeat(${p.currentShape[0].length}, 1fr)`;
        el.style.zIndex = p.zIndex || 100;
        
        p.currentShape.forEach((row, r) => {
            row.forEach((v, c) => {
                const b = document.createElement('div');
                if(v) { 
                    b.className = 'block'; 
                    b.style.backgroundColor = p.color; 
                    
                    const atom = document.createElement('div');
                    atom.className = 'visual-atom';
                    atom.style.backgroundColor = p.color;
                    b.appendChild(atom);

                    if(c + 1 < row.length && row[c+1]) {
                        const h = document.createElement('div'); h.className = 'connector-h'; b.appendChild(h);
                    }
                    if(r + 1 < p.currentShape.length && p.currentShape[r+1][c]) {
                        const v = document.createElement('div'); v.className = 'connector-v'; b.appendChild(v);
                    }
                }
                else b.style.visibility = 'hidden';
                el.appendChild(b);
            });
        });

        if(!isInTray) placeOnBoard(el, p.x, p.y);
        else {
            el.style.left = `${p.trayX}px`;
            el.style.top = `${p.trayY}px`;
            trayEl.appendChild(el);
        }

        if(!p.isLocked) setupInteraction(el, idx);
    });
}

function placeOnBoard(el, x, y) {
    const gap = 2; const padding = 10; 
    el.style.left = `${padding + x * (cellSize + gap)}px`;
    el.style.top = `${padding + y * (cellSize + gap)}px`;
    boardEl.appendChild(el);
}

function setupInteraction(el, idx) {
    el.addEventListener('mousedown', (e) => handleMouseDown(e, idx, el));
    el.addEventListener('touchstart', (e) => handleTouchStart(e, idx, el), {passive: false});
}

function getHoveredGridPosition(pieceIdx, el) {
    const p = pieces[pieceIdx];
    const bRect = boardEl.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    
    const gap = 2; const padding = 10;
    const relX = elRect.left - bRect.left - padding;
    const relY = elRect.top - bRect.top - padding;
    
    const gx = Math.round(relX / (cellSize + gap));
    const gy = Math.round(relY / (cellSize + gap));
    
    const valid = canPlace(p.currentShape, gy, gx);
    
    return { r: gy, c: gx, valid: valid, pxX: padding + gx*(cellSize+gap), pxY: padding + gy*(cellSize+gap) };
}

function updateGhost(idx) {
    const el = document.getElementById(`p-${idx}`);
    if(!el) return;
    
    const result = getHoveredGridPosition(idx, el);
    const p = pieces[idx];

    if(result.valid) {
        lastValidGhostPos = { r: result.r, c: result.c };

        ghostEl.style.display = 'grid';
        ghostEl.style.gridTemplateColumns = `repeat(${p.currentShape[0].length}, 1fr)`;
        ghostEl.innerHTML = ''; 
        p.currentShape.forEach(row => row.forEach(v => {
            const b = document.createElement('div');
            if(v) b.className = 'ghost-block';
            else b.style.visibility = 'hidden';
            ghostEl.appendChild(b);
        }));
        
        ghostEl.style.left = `${result.pxX}px`;
        ghostEl.style.top = `${result.pxY}px`;
        ghostEl.style.zIndex = globalZIndex + 1; 
    } else {
        lastValidGhostPos = null; 
        ghostEl.style.display = 'none';
    }
}

// ğŸ–±ï¸ PC Mouse
function handleMouseDown(e, idx, el) {
    e.stopPropagation(); 
    if(e.button === 2) { flipPieceData(idx); return; } 
    if(e.button !== 0) return;
    
    if(pickedPieceIdx !== null) {
        dropPiece(pickedPieceIdx, document.getElementById(`p-${pickedPieceIdx}`));
        return;
    }

    if(pickedPieceIdx === null) {
        pieces[idx].zIndex = ++globalZIndex;
        el.style.zIndex = pieces[idx].zIndex;

        const rect = el.getBoundingClientRect();
        dragOffsetX = e.clientX - rect.left;
        dragOffsetY = e.clientY - rect.top;
        pickUpPiece(idx, el, e.clientX, e.clientY);
    }
}

function pickUpPiece(idx, el, startX, startY) {
    pickedPieceIdx = idx;
    const p = pieces[idx];
    
    dragStartGridX = p.x;
    dragStartGridY = p.y;
    lastValidGhostPos = null; 
    // recentValidGhostPos ê´€ë ¨ ì‚­ì œë¨ (ë” ì´ìƒ ì‚¬ìš© ì•ˆ í•¨)

    // 1ì°¨ ì„¸ì²™: ì§‘ì„ ë•Œ í”ì  ì§€ìš°ê¸°
    for(let r=0; r<ROWS; r++) {
        for(let c=0; c<COLS; c++) {
            if(boardState[r][c] === p.id) boardState[r][c] = -1;
        }
    }

    el.classList.remove('in-tray', 'on-board');
    el.classList.add('picked-up');
    document.body.appendChild(el);
    el.style.left = `${startX - dragOffsetX}px`;
    el.style.top = `${startY - dragOffsetY}px`;

    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('wheel', onWheel, {passive: false});
    document.addEventListener('mousedown', onGlobalClick);
    document.addEventListener('touchstart', onGlobalTouchStart, {passive: false}); 
    
    updateGhost(idx);
}

function updateGhost(idx) {
    const el = document.getElementById(`p-${idx}`);
    if(!el) return;
    
    const result = getHoveredGridPosition(idx, el);
    const p = pieces[idx];

    if(result.valid) {
        lastValidGhostPos = { r: result.r, c: result.c };
        
        ghostEl.style.display = 'grid';
        ghostEl.style.gridTemplateColumns = `repeat(${p.currentShape[0].length}, 1fr)`;
        ghostEl.innerHTML = ''; 
        p.currentShape.forEach(row => row.forEach(v => {
            const b = document.createElement('div');
            if(v) b.className = 'ghost-block';
            else b.style.visibility = 'hidden';
            ghostEl.appendChild(b);
        }));
        
        ghostEl.style.left = `${result.pxX}px`;
        ghostEl.style.top = `${result.pxY}px`;
        ghostEl.style.zIndex = globalZIndex + 1; 
    } else {
        lastValidGhostPos = null; 
        ghostEl.style.display = 'none';
    }
}
    
function onMouseMove(e) {
    if(pickedPieceIdx !== null) {
        const el = document.getElementById(`p-${pickedPieceIdx}`);
        el.style.left = `${e.clientX - dragOffsetX}px`;
        el.style.top = `${e.clientY - dragOffsetY}px`;
        updateGhost(pickedPieceIdx);
    }
}

function onWheel(e) {
    if(pickedPieceIdx !== null) { e.preventDefault(); rotatePieceData(pickedPieceIdx); }
}

function onGlobalClick(e) {
    if(pickedPieceIdx !== null) {
        if(e.button === 2) return; 
        dropPiece(pickedPieceIdx, document.getElementById(`p-${pickedPieceIdx}`));
    }
}

function onGlobalTouchStart(e) {
    if(pickedPieceIdx !== null && e.touches.length > 1) {
        e.preventDefault();
        hasRotated = true; // ğŸ’¡ ë©€í‹° í„°ì¹˜ ë°œìƒ ì‹œ 'íšŒì „í–ˆìŒ'ìœ¼ë¡œ í‘œì‹œ
        rotatePieceData(pickedPieceIdx);
    }
}

function dropPiece(idx, el) {
    const p = pieces[idx];

    // ğŸ›¡ï¸ [2ì°¨ ì•ˆì „ì¥ì¹˜] ë‚´ë ¤ë†“ëŠ” ìˆœê°„ ë³´ë“œì— ìê¸° ìì‹ ì˜ ì”ìƒì´ ìˆë‹¤ë©´ ê°•ì œë¡œ ì§€ì›ë‹ˆë‹¤.
    // ì´ ì½”ë“œê°€ "íšŒì „ í›„ 1íšŒ íŠ•ê¹€" í˜„ìƒì„ ì™„ë²½í•˜ê²Œ ë§‰ì•„ì¤ë‹ˆë‹¤.
    for(let r=0; r<ROWS; r++) {
        for(let c=0; c<COLS; c++) {
            if(boardState[r][c] === p.id) boardState[r][c] = -1;
        }
    }

    // ìƒíƒœ ë™ê¸°í™”: í˜¹ì‹œ ëª¨ë¥¼ ì¢Œí‘œ ë¶ˆì¼ì¹˜ë¥¼ ìœ„í•´ ê³ ìŠ¤íŠ¸ ìœ„ì¹˜ë¥¼ í•œ ë²ˆ ë” ê°±ì‹ 
    updateGhost(idx);

    let targetR, targetC, isValid = false;

    // 1. ê³ ìŠ¤íŠ¸ ìœ„ì¹˜ê°€ ìˆë‹¤ë©´ ìµœìš°ì„  ì ìš©
    if (lastValidGhostPos && canPlace(p.currentShape, lastValidGhostPos.r, lastValidGhostPos.c)) {
        targetR = lastValidGhostPos.r;
        targetC = lastValidGhostPos.c;
        isValid = true;
    } 
    // 2. ê³ ìŠ¤íŠ¸ê°€ ì—†ê±°ë‚˜ ì‹¤íŒ¨í–ˆë‹¤ë©´ í˜„ì¬ ì¢Œí‘œë¡œ ì¬ê³„ì‚°
    else {
        const result = getHoveredGridPosition(idx, el);
        if (result.valid) {
            targetR = result.r;
            targetC = result.c;
            isValid = true;
        }
    }
    
    if (isValid) {
        // ì„±ê³µ: ê²Œì„íŒì— ë°°ì¹˜
        placePieceToBoardState(p.currentShape, targetR, targetC, p.id);
        p.x = targetC; p.y = targetR;
        checkWinCondition();
    } else {
        // ì‹¤íŒ¨: íŠ¸ë ˆì´ ì˜ì—­ í™•ì¸
        const trayRect = trayEl.getBoundingClientRect();
        const pieceRect = el.getBoundingClientRect();
        
        const pieceCX = pieceRect.left + pieceRect.width / 2;
        const pieceCY = pieceRect.top + pieceRect.height / 2;

        const buffer = 50; 
        const insideTrayArea = (
            pieceCX >= trayRect.left - buffer &&
            pieceCX <= trayRect.right + buffer &&
            pieceCY >= trayRect.top - buffer &&
            pieceCY <= trayRect.bottom + buffer
        );

        if (insideTrayArea) {
             let newTrayX = pieceRect.left - trayRect.left;
             let newTrayY = pieceRect.top - trayRect.top;

             const trayW = trayEl.clientWidth;
             const trayH = trayEl.clientHeight;
             const pieceW = pieceRect.width;
             const pieceH = pieceRect.height;
             
             newTrayX = Math.max(0, Math.min(newTrayX, trayW - pieceW));
             newTrayY = Math.max(0, Math.min(newTrayY, trayH - pieceH));

             p.trayX = newTrayX;
             p.trayY = newTrayY;
             p.x = -1; p.y = -1; 
        } else {
            returnToTrayRandomly(p);
        }
    }

    cleanupListeners();
    pickedPieceIdx = null; 
    ghostEl.style.display = 'none';
    lastValidGhostPos = null;
    renderPieces();
}
    
function returnToTrayRandomly(p) {
    p.x = -1; p.y = -1;
    const trayW = trayEl.clientWidth || 350;
    const trayH = trayEl.clientHeight || 300;
    const pWidth = p.currentShape[0].length * cellSize;
    const pHeight = p.currentShape.length * cellSize;
    p.trayX = Math.random() * (trayW - pWidth - 10);
    p.trayY = Math.random() * (trayH - pHeight - 10);
}

function cleanupListeners() {
    document.removeEventListener('mousemove', onMouseMove);
    document.removeEventListener('wheel', onWheel);
    document.removeEventListener('mousedown', onGlobalClick);
    document.removeEventListener('touchstart', onGlobalTouchStart); 
}

// ğŸ“± Mobile Logic
function handleTouchStart(e, idx, el) {
    e.preventDefault(); e.stopPropagation();

    if (e.touches.length > 1 && pickedPieceIdx === idx) return;
    if(pickedPieceIdx !== null && pickedPieceIdx !== idx) return;

    pieces[idx].zIndex = ++globalZIndex;
    el.style.zIndex = pieces[idx].zIndex;

    const touch = e.touches[0];
    const touchId = touch.identifier;

    isDragging = false;
    hasRotated = false; // ğŸ’¡ í„°ì¹˜ ì‹œì‘ ì‹œ íšŒì „ í”Œë˜ê·¸ ì´ˆê¸°í™”
    startX = touch.clientX;
    startY = touch.clientY;
    
    const rect = el.getBoundingClientRect();
    dragOffsetX = touch.clientX - rect.left;
    dragOffsetY = touch.clientY - rect.top;

    pickUpPiece(idx, el, touch.clientX, touch.clientY);

    const onTouchMove = (ev) => {
        ev.preventDefault();
        
        let myTouch = null;
        for(let i=0; i<ev.touches.length; i++) {
            if(ev.touches[i].identifier === touchId) {
                myTouch = ev.touches[i];
                break;
            }
        }
        if(!myTouch) return;

        if (Math.abs(myTouch.clientX - startX) > 10 || Math.abs(myTouch.clientY - startY) > 10) {
            isDragging = true;
        }
        
        el.style.left = `${myTouch.clientX - dragOffsetX}px`;
        el.style.top = `${myTouch.clientY - dragOffsetY}px`;
        updateGhost(idx);
    };
    
    const onTouchEnd = (ev) => {
        let myTouchStillActive = false;
        for(let i=0; i<ev.touches.length; i++) {
            if(ev.touches[i].identifier === touchId) {
                myTouchStillActive = true;
                break;
            }
        }
        if(myTouchStillActive) return;

        document.removeEventListener('touchmove', onTouchMove);
        document.removeEventListener('touchend', onTouchEnd);
        
        // ğŸ’¡ ìˆ˜ì •ë¨: ë“œë˜ê·¸í•˜ì§€ ì•Šì•˜ë”ë¼ë„, 'íšŒì „'ì„ í–ˆë‹¤ë©´ ë’¤ì§‘ì§€ ì•Šê³  ë°”ë¡œ ë‚´ë ¤ë†“ìŠµë‹ˆë‹¤.
        if(!isDragging && !hasRotated) { 
            flipPieceData(idx);
            
            const p = pieces[idx];
            if (dragStartGridX !== -1 && canPlace(p.currentShape, dragStartGridY, dragStartGridX)) {
                placePieceToBoardState(p.currentShape, dragStartGridY, dragStartGridX, p.id);
                p.x = dragStartGridX; 
                p.y = dragStartGridY;
                cleanupListeners();
                pickedPieceIdx = null; 
                ghostEl.style.display = 'none';
                renderPieces();
            } else {
                if(dragStartGridX !== -1) {
                    flipPieceData(idx); 
                    placePieceToBoardState(p.currentShape, dragStartGridY, dragStartGridX, p.id);
                    p.x = dragStartGridX; 
                    p.y = dragStartGridY;
                    cleanupListeners();
                    pickedPieceIdx = null; 
                    ghostEl.style.display = 'none';
                    renderPieces();
                } else {
                    dropPiece(idx, el);
                }
            }
        } else {
            dropPiece(idx, el);
        }
    };
    document.addEventListener('touchmove', onTouchMove, {passive: false});
    document.addEventListener('touchend', onTouchEnd);
}

// Logic Utils (Re-rendering Fix)
function rotatePieceData(idx) {
    const p = pieces[idx];
    const oldShape = p.currentShape;
    const newShape = rotateMatrix(oldShape);
    p.currentShape = newShape;
    updateVisualsInDrag(idx); // ì¦‰ì‹œ ë Œë”ë§ í˜¸ì¶œ
}

    // ğŸ†• ì¡°ê°ì„ ë¬´ì‘ìœ„ë¡œ íšŒì „ ë° ë’¤ì§‘ëŠ” í•¨ìˆ˜
function randomizePieceOrientation(idx) {
    const p = pieces[idx];
    
    // 1. ë¬´ì‘ìœ„ ë’¤ì§‘ê¸° (50% í™•ë¥ )
    if (Math.random() > 0.5) {
        p.currentShape = p.currentShape.map(row => [...row].reverse());
    }
    
    // 2. ë¬´ì‘ìœ„ íšŒì „ (0~3ë²ˆ)
    const rotCount = Math.floor(Math.random() * 4);
    for (let i = 0; i < rotCount; i++) {
        p.currentShape = rotateMatrix(p.currentShape);
    }
}

function flipPieceData(idx) {
    const p = pieces[idx];
    const oldShape = p.currentShape;
    const newShape = oldShape.map(row => [...row].reverse());
    p.currentShape = newShape;
    updateVisualsInDrag(idx); // ì¦‰ì‹œ ë Œë”ë§ í˜¸ì¶œ
}

function rotateMatrix(m) {
    const R=m.length, C=m[0].length;
    let n=Array(C).fill().map(()=>Array(R).fill(0));
    for(let r=0; r<R; r++) for(let c=0; c<C; c++) n[c][R-1-r]=m[r][c];
    return n;
}

function canPlace(shape, r, c) {
    for(let i=0; i<shape.length; i++) for(let j=0; j<shape[0].length; j++) 
        if(shape[i][j] && (r+i>=ROWS || c+j>=COLS || r+i<0 || c+j<0 || boardState[r+i][c+j]!==-1)) return false;
    return true;
}
function placePieceToBoardState(shape, r, c, id) {
    for(let i=0; i<shape.length; i++) for(let j=0; j<shape[0].length; j++) if(shape[i][j]) boardState[r+i][c+j]=id;
}

function checkWinCondition() {
    const remainingPieces = pieces.filter(p => p.x === -1).length;
    
    if(remainingPieces === 0) {
        const msgBox = document.querySelector('#board-message-box h2');
        const subMsg = document.querySelector('#board-message-box p');
        
        if (isChallengerMode) {
            stopTimer();
            const now = Date.now();
            const diff = now - startTime; // í˜„ì¬ ê±¸ë¦° ì‹œê°„(ms)
            const recordStr = document.getElementById('game-timer').innerText; // ë¬¸ìì—´ ê¸°ë¡
            
            let msg = `<span style="color:#fab1a0">${recordStr}</span>`;
            
// checkWinCondition í•¨ìˆ˜ ë‚´ë¶€ì˜ if (diff < bestTime) ë¸”ë¡ ìˆ˜ì •
// checkWinCondition í•¨ìˆ˜ ë‚´ë¶€ì˜ ì‹ ê¸°ë¡ ë‹¬ì„± ë¸”ë¡ ì°¾ê¸°
if (diff < bestTime) {
    bestTime = diff;
    const title = getModeTitle(currentDifficultyMode);
    
    // âœ… innerText ëŒ€ì‹  innerHTMLì„ ì‚¬ìš©í•˜ì—¬ ìš°ë¦¬ê°€ ì„¤ì •í•œ í°íŠ¸ í´ë˜ìŠ¤ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.
    document.getElementById('best-record').innerHTML = 
        `<span class="best-txt">${title}</span><span class="best-time">${recordStr}</span>`;
    
    msg += `<br><span style="font-size:0.7em; color:#ffffff; font-weight:bold;">âœ¨ NEW RECORD! âœ¨</span>`;
    playSound('success');
}
            
            msgBox.innerHTML = msg;
            subMsg.innerText = "í¼ì¦ì„ ì™„ì„±í–ˆì–´ìš”! ğŸ†";
        } else {
            msgBox.innerText = "ëƒ¥ëˆ„ë“¤ ë§ˆìŠ¤í„°!";
            subMsg.innerText = "í¼ì¦ì„ ì™„ì„±í–ˆì–´ìš”ğŸ‰";
        }

        const bOverlay = document.getElementById('board-overlay');
        if(bOverlay) bOverlay.style.display = 'flex';
    }
}
function showMessage(t) {
    const m=document.getElementById('message'); m.textContent=t; m.style.display='block';
    setTimeout(()=>m.style.display='none', 2000);
}

// -------------------------------------------------------
// ğŸ•µï¸â€â™€ï¸ [ê°œë°œì ì „ìš© ì¹˜íŠ¸í‚¤] Consoleì—ì„œ jump(ë²ˆí˜¸) ì…ë ¥í•˜ë©´ ì´ë™!
// -------------------------------------------------------
window.jump = function(num) {
    // 1. ìœ íš¨ì„± ê²€ì‚¬
    if (!num || num < 1) {
        console.error("ğŸš« 1 ì´ìƒì˜ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        return;
    }

    // 2. ë ˆë²¨ ì„¤ì • ë§¤ì§
    // ê¸°ì¡´ ë¡œì§ì´ (í˜„ì¬ë²ˆí˜¸ + 1)ì„ ë¡œë“œí•˜ë„ë¡ ë˜ì–´ ìˆì–´ì„œ,
    // (ì›í•˜ëŠ”ë²ˆí˜¸ - 2)ë¡œ ì„¤ì •í•´ì•¼ ìµœì¢…ì ìœ¼ë¡œ (ì›í•˜ëŠ”ë²ˆí˜¸ - 1) ì¸ë±ìŠ¤ê°€ ë©ë‹ˆë‹¤.
    // ì˜ˆ: 81ë²ˆì„ ì›í•¨ -> ì¸ë±ìŠ¤ 80 í•„ìš” -> 79ë¡œ ì„¤ì • -> ë¡œì§ì´ +1 í•´ì„œ 80(81ë²ˆ) ë¡œë“œ
    currentProblemIdx = num - 2;

    // 3. ê²Œì„ ê°•ì œ ì‹¤í–‰
    // ëª¨ë‹¬ ë‹«ê¸°ë‚˜ í™•ì¸ ê³¼ì • ì—†ì´ ë°”ë¡œ ë¡œì§ì„ íƒœì›ë‹ˆë‹¤.
    loadNewGameLogic();

    console.log(`ğŸš€ ${num}ë²ˆ ë ˆë²¨ë¡œ ì›Œí”„ ì„±ê³µ! (Index: ${num-1})`);
};
    
window.addEventListener('resize', initLayout);
initLayout();
loadNewGame();
</script>

</body>
</html>
