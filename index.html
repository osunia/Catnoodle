<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kanoodle Puzzle Generator</title>
    <style>
        :root {
            --bg-color: #f0f4f8;
            --board-bg: #2c3e50;
            --hole-color: #1a252f;
            --tray-bg: #ffffff;
            --primary-btn: #3498db;
            --secondary-btn: #e74c3c;
            --text-color: #333;
            --cell-size: 30px; /* ì´ˆê¸°ê°’ */
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: none;
        }

        header { margin: 15px 0; text-align: center; }
        h1 { margin: 0; font-size: 1.5rem; color: var(--board-bg); }
        p { margin: 5px 0 0; font-size: 0.9rem; color: #666; }

        .controls {
            display: flex; gap: 10px; margin-bottom: 10px;
            flex-wrap: wrap; justify-content: center;
        }

        select, button {
            padding: 8px 12px; border-radius: 20px; border: none; font-size: 0.9rem;
            cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn-gen { background: var(--primary-btn); color: white; font-weight: bold; }
        .btn-check { background: #27ae60; color: white; }
        .btn-answer { background: var(--secondary-btn); color: white; }

        #game-container {
            display: flex; flex-direction: column; align-items: center;
            gap: 15px; width: 100%; max-width: 600px;
        }

        #board {
            display: grid;
            grid-template-columns: repeat(11, var(--cell-size));
            grid-template-rows: repeat(5, var(--cell-size));
            gap: 2px;
            background-color: var(--board-bg);
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            position: relative; /* ì¤‘ìš” */
        }

        .cell {
            width: var(--cell-size); height: var(--cell-size);
            background-color: var(--hole-color);
            border-radius: 50%;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.5);
        }

        #tray {
            width: 95%; min-height: 120px;
            background-color: var(--tray-bg);
            border-radius: 15px; padding: 10px;
            display: flex; flex-wrap: wrap;
            justify-content: center; align-items: center; gap: 10px;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .piece {
            position: absolute;
            display: grid; gap: 2px;
            cursor: grab; touch-action: none;
            transition: transform 0.1s;
            z-index: 10;
            pointer-events: auto;
        }
        
        .piece.in-tray {
            position: relative;
            transform: scale(0.7); /* íŠ¸ë ˆì´ì—ì„  ì¢€ ë” ì‘ê²Œ */
        }

        .piece.locked { cursor: not-allowed; filter: brightness(0.7); pointer-events: none; }
        .block {
            width: var(--cell-size); height: var(--cell-size);
            border-radius: 50%;
            box-shadow: inset -2px -2px 4px rgba(0,0,0,0.2), 2px 2px 4px rgba(255,255,255,0.3);
            border: 1px solid rgba(0,0,0,0.1);
        }

        /* ğŸ”„ ë¡œë”© ìŠ¤í”¼ë„ˆ */
        #loading {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 9999;
        }
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-btn);
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #message {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); color: white;
            padding: 15px 25px; border-radius: 30px;
            display: none; z-index: 2000; text-align: center;
        }
    </style>
</head>
<body>

<div id="loading">
    <div class="spinner"></div>
    <p style="margin-top: 20px; font-weight: bold;">í¼ì¦ ìƒì„± ì¤‘... ğŸ§©</p>
</div>

<header>
    <h1>ğŸ§© ì¹´ëˆ„ë“¤ ë§ˆìŠ¤í„°</h1>
    <p>ë¹ˆì¹¸ì„ ì±„ìš°ì„¸ìš”. (í´ë¦­: íšŒì „)</p>
</header>

<div class="controls">
    <select id="difficulty">
        <option value="2">ì‰¬ì›€ (2ê°œ ê³ ì •)</option>
        <option value="4" selected>ë³´í†µ (4ê°œ ê³ ì •)</option>
        <option value="6">ì–´ë ¤ì›€ (6ê°œ ê³ ì •)</option>
    </select>
    <button class="btn-gen" onclick="startGame()">ğŸ”„ ìƒˆ ë¬¸ì œ</button>
    <button class="btn-check" onclick="checkSolution()">âœ¨ ì±„ì </button>
    <button class="btn-answer" onclick="showAnswer()">ğŸ‘€ ì •ë‹µ</button>
</div>

<div id="game-container">
    <div id="board"></div>
    <div id="tray"></div>
</div>

<div id="message"></div>

<script>
// ì„¤ì •
const COLS = 11;
const ROWS = 5;
const SHAPES_DEF = [
    { id: 0, color: '#FF6B6B', shape: [[1,1,1,1,1]] }, 
    { id: 1, color: '#4ECDC4', shape: [[1,1],[1,1]] }, 
    { id: 2, color: '#45B7D1', shape: [[1,1,1],[0,1,0]] }, 
    { id: 3, color: '#96CEB4', shape: [[1,1,0],[0,1,1]] }, 
    { id: 4, color: '#FFEEAD', shape: [[1,1,1,1]] }, 
    { id: 5, color: '#D4A5A5', shape: [[1,0],[1,0],[1,1]] }, 
    { id: 6, color: '#9B59B6', shape: [[1,1,1],[1,0,0],[1,0,0]] }, 
    { id: 7, color: '#3498DB', shape: [[1,0,0],[1,1,1],[0,0,1]] }, 
    { id: 8, color: '#E67E22', shape: [[0,1,0],[1,1,1],[0,1,0]] }, 
    { id: 9, color: '#1ABC9C', shape: [[1,0],[1,1],[1,1]] }, 
    { id: 10, color: '#F1C40F', shape: [[1,0,1],[1,1,1]] }, 
    { id: 11, color: '#E74C3C', shape: [[0,0,1],[1,1,1],[1,0,0]] } 
];

let boardState = [];
let answerKey = [];
let pieces = [];
let cellSize = 30;

// ìš”ì†Œ ì°¸ì¡°
const boardEl = document.getElementById('board');
const trayEl = document.getElementById('tray');
const loadingEl = document.getElementById('loading');

// 1. ì´ˆê¸°í™” ë° ë¦¬ì‚¬ì´ì¦ˆ
function initLayout() {
    const containerWidth = document.getElementById('game-container').offsetWidth;
    // 11ì¹¸ + íŒ¨ë”© ê³ ë ¤
    cellSize = Math.floor((containerWidth - 30) / 11);
    if(cellSize > 40) cellSize = 40; // ìµœëŒ€ í¬ê¸° ì œí•œ
    
    document.documentElement.style.setProperty('--cell-size', `${cellSize}px`);
    createGrid();
    renderPieces(); // ìœ„ì¹˜ ì¬ì¡°ì •
}

function createGrid() {
    boardEl.innerHTML = '';
    for(let i=0; i<ROWS*COLS; i++) {
        const div = document.createElement('div');
        div.className = 'cell';
        boardEl.appendChild(div);
    }
}

// 2. ê²Œì„ ì‹œì‘ (ë¹„ë™ê¸° ì²˜ë¦¬)
function startGame() {
    loadingEl.style.display = 'flex';
    // UI ë Œë”ë§ì„ ìœ„í•´ ì•½ê°„ì˜ ì§€ì—° í›„ ê³„ì‚° ì‹œì‘
    setTimeout(() => {
        try {
            generatePuzzle();
            loadingEl.style.display = 'none';
        } catch (e) {
            console.error(e);
            alert("ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            loadingEl.style.display = 'none';
        }
    }, 100);
}

// 3. í¼ì¦ ìƒì„± (ë°±íŠ¸ë˜í‚¹)
function generatePuzzle() {
    boardState = Array(ROWS).fill().map(() => Array(COLS).fill(-1));
    trayEl.innerHTML = '';
    
    // ì¡°ê° ì´ˆê¸°í™”
    pieces = SHAPES_DEF.map(p => ({
        ...p,
        currentShape: p.shape,
        x: -1, y: -1,
        isLocked: false
    }));

    // ëœë¤ ì…”í”Œ
    let indices = pieces.map((_, i) => i).sort(() => Math.random() - 0.5);
    
    // íƒ€ì„ì•„ì›ƒ ë°©ì§€ë¥¼ ìœ„í•œ ë°˜ë³µ ì œí•œ ì„¤ì •ë„ ì¢‹ì§€ë§Œ, ì—¬ê¸°ì„  ì¼ë‹¨ ë‹¨ìˆœ ë°±íŠ¸ë˜í‚¹
    if (solveBoard(0, indices)) {
        answerKey = JSON.parse(JSON.stringify(boardState));
        setupLevel();
        renderPieces();
        showMessage("ë¬¸ì œ ìƒì„± ì™„ë£Œ! ğŸ®");
    } else {
        // ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ (ì¬ê·€ ìœ„í—˜ì´ ìˆìœ¼ë¯€ë¡œ 1íšŒë§Œ)
        console.warn("Retrying generation...");
        // ì…”í”Œ ë‹¤ì‹œ í•´ì„œ ì¬ì‹œë„
        generatePuzzle(); 
    }
}

function solveBoard(idx, indices) {
    if (idx >= indices.length) return true;

    const pIdx = indices[idx];
    const piece = pieces[pIdx];
    
    // ê°„ë‹¨í•œ ìµœì í™”: 4ë°©í–¥ íšŒì „ + ë°˜ì „(2) * 4íšŒì „ = 8ê°€ì§€
    // ì„±ëŠ¥ì„ ìœ„í•´, ë³´ë“œì˜ ë¹ˆì¹¸ ì¤‘ 'ê°€ì¥ ìœ—ì¤„ ì™¼ìª½'ë¶€í„° ì±„ìš°ë„ë¡ ê°•ì œí•˜ë©´ ë¹¨ë¼ì§ˆ ìˆ˜ ìˆìŒ
    // í•˜ì§€ë§Œ ëœë¤ì„±ì„ ìœ„í•´ ì „ì²´ íƒìƒ‰ ìœ ì§€í•˜ë˜, ê°€ì§€ì¹˜ê¸° í•„ìš”.
    
    // ê°€ëŠ¥í•œ ë³€í˜• ë¯¸ë¦¬ ìƒì„± (ì¤‘ë³µ ì œê±°)
    let variations = getUniqueVariations(piece.shape);
    
    for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
            if (boardState[r][c] !== -1) continue;

            for (let v of variations) {
                if (canPlace(v, r, c)) {
                    placePiece(v, r, c, pIdx);
                    if (solveBoard(idx + 1, indices)) {
                        pieces[pIdx].currentShape = v;
                        pieces[pIdx].x = c; pieces[pIdx].y = r;
                        return true;
                    }
                    removePiece(v, r, c);
                }
            }
            // ìµœì í™”: í˜„ì¬ ë¹ˆì¹¸(r,c)ì„ ì±„ìš°ì§€ ëª»í•˜ë©´ ë” ì§„í–‰í•´ë„ ì†Œìš©ì—†ìœ¼ë¯€ë¡œ false ë°˜í™˜
            // ì´ ë¡œì§ì€ ë°±íŠ¸ë˜í‚¹ ì†ë„ë¥¼ íšê¸°ì ìœ¼ë¡œ ì¤„ì—¬ì¤Œ
            return false; 
        }
    }
    return false;
}

function getUniqueVariations(matrix) {
    let vars = [];
    let m = matrix;
    let jsonSet = new Set();
    
    // íšŒì „ 4ë²ˆ
    for(let i=0; i<4; i++) {
        let s = JSON.stringify(m);
        if(!jsonSet.has(s)) { vars.push(m); jsonSet.add(s); }
        m = rotateMatrix(m);
    }
    // ëŒ€ì¹­
    m = m.slice().reverse();
    for(let i=0; i<4; i++) {
        let s = JSON.stringify(m);
        if(!jsonSet.has(s)) { vars.push(m); jsonSet.add(s); }
        m = rotateMatrix(m);
    }
    return vars;
}

function rotateMatrix(m) {
    const R = m.length, C = m[0].length;
    let newM = Array(C).fill().map(() => Array(R).fill(0));
    for(let r=0; r<R; r++) for(let c=0; c<C; c++) newM[c][R-1-r] = m[r][c];
    return newM;
}

function canPlace(shape, r, c) {
    for(let i=0; i<shape.length; i++) {
        for(let j=0; j<shape[0].length; j++) {
            if(shape[i][j]===1) {
                if(r+i>=ROWS || c+j>=COLS || boardState[r+i][c+j]!==-1) return false;
            }
        }
    }
    return true;
}

function placePiece(shape, r, c, id) {
    for(let i=0; i<shape.length; i++) for(let j=0; j<shape[0].length; j++) if(shape[i][j]) boardState[r+i][c+j]=id;
}
function removePiece(shape, r, c) {
    for(let i=0; i<shape.length; i++) for(let j=0; j<shape[0].length; j++) if(shape[i][j]) boardState[r+i][c+j]=-1;
}

// 4. ë ˆë²¨ ì„¤ì •
function setupLevel() {
    const diff = parseInt(document.getElementById('difficulty').value);
    let all = pieces.map((_,i)=>i);
    let locked = [];
    
    for(let i=0; i<diff; i++) {
        if(!all.length) break;
        let r = Math.floor(Math.random()*all.length);
        locked.push(all[r]);
        all.splice(r,1);
    }
    
    pieces.forEach((p, i) => {
        if(locked.includes(i)) {
            p.isLocked = true;
        } else {
            p.isLocked = false;
            removePiece(p.currentShape, p.y, p.x);
            p.x = -1; p.y = -1;
        }
    });
}

// 5. ë Œë”ë§
function renderPieces() {
    document.querySelectorAll('.piece').forEach(e => e.remove());
    pieces.forEach((p, idx) => {
        const el = document.createElement('div');
        el.className = `piece ${p.x===-1?'in-tray':''} ${p.isLocked?'locked':''}`;
        el.id = `p-${idx}`;
        el.style.gridTemplateColumns = `repeat(${p.currentShape[0].length}, 1fr)`;
        
        p.currentShape.forEach(row => {
            row.forEach(v => {
                const b = document.createElement('div');
                if(v) { b.className = 'block'; b.style.backgroundColor = p.color; }
                else b.style.visibility = 'hidden';
                el.appendChild(b);
            });
        });

        if(p.x !== -1) placeOnBoard(el, p.x, p.y);
        else trayEl.appendChild(el);

        if(!p.isLocked) {
            el.onpointerdown = (e) => startDrag(e, idx, el);
            el.onclick = (e) => { if(!isDragging) rotatePiece(idx); };
        }
    });
}

function placeOnBoard(el, x, y) {
    const gap = 2;
    // íŒ¨ë”© 10px + ì¢Œí‘œ ê³„ì‚°
    const left = 10 + x * (cellSize + gap);
    const top = 10 + y * (cellSize + gap);
    el.style.left = `${left}px`;
    el.style.top = `${top}px`;
    el.style.position = 'absolute';
    boardEl.appendChild(el);
}

// 6. ë“œë˜ê·¸ ë¡œì§
let isDragging = false;
function startDrag(e, idx, el) {
    e.preventDefault();
    isDragging = false;
    const startX = e.clientX || e.touches[0].clientX;
    const startY = e.clientY || e.touches[0].clientY;
    const rect = el.getBoundingClientRect();
    const offX = startX - rect.left;
    const offY = startY - rect.top;

    el.style.zIndex = 1000;
    el.classList.remove('in-tray');
    document.body.appendChild(el);

    function onMove(ev) {
        if(Math.abs((ev.clientX||ev.touches[0].clientX) - startX) > 5) isDragging = true;
        const cx = ev.clientX || ev.touches[0].clientX;
        const cy = ev.clientY || ev.touches[0].clientY;
        el.style.position = 'fixed';
        el.style.left = `${cx - offX}px`;
        el.style.top = `${cy - offY}px`;
    }

    function onUp(ev) {
        document.removeEventListener('pointermove', onMove);
        document.removeEventListener('pointerup', onUp);
        
        if(!isDragging) { renderPieces(); return; } // í´ë¦­ ì²˜ë¦¬

        // ë“œë¡­
        const bRect = boardEl.getBoundingClientRect();
        const eRect = el.getBoundingClientRect();
        const cx = eRect.left + eRect.width/2;
        const cy = eRect.top + eRect.height/2;

        if(cx > bRect.left && cx < bRect.right && cy > bRect.top && cy < bRect.bottom) {
            const gap = 2;
            const gx = Math.round((eRect.left - bRect.left - 10) / (cellSize + gap));
            const gy = Math.round((eRect.top - bRect.top - 10) / (cellSize + gap));

            // ìœ íš¨ì„± ì²´í¬
            if(canPlace(pieces[idx].currentShape, gy, gx)) {
                if(pieces[idx].x !== -1) removePiece(pieces[idx].currentShape, pieces[idx].y, pieces[idx].x);
                placePiece(pieces[idx].currentShape, gy, gx, idx);
                pieces[idx].x = gx; pieces[idx].y = gy;
            } else {
                // ì‹¤íŒ¨ ì‹œ ë³µê·€
                if(pieces[idx].x === -1) { pieces[idx].x = -1; }
            }
        } else {
            // ë³´ë“œ ë°–
            if(pieces[idx].x !== -1) removePiece(pieces[idx].currentShape, pieces[idx].y, pieces[idx].x);
            pieces[idx].x = -1; pieces[idx].y = -1;
        }
        renderPieces();
    }
    document.addEventListener('pointermove', onMove);
    document.addEventListener('pointerup', onUp);
}

function rotatePiece(idx) {
    const p = pieces[idx];
    const oldShape = p.currentShape;
    const newShape = rotateMatrix(oldShape);
    
    // íŠ¸ë ˆì´ì— ìˆìœ¼ë©´ ê·¸ëƒ¥ íšŒì „
    if(p.x === -1) {
        p.currentShape = newShape;
        renderPieces();
        return;
    }
    
    // ë³´ë“œ ìœ„ì— ìˆìœ¼ë©´ ìœ íš¨ì„± ê²€ì‚¬
    removePiece(oldShape, p.y, p.x);
    if(canPlace(newShape, p.y, p.x)) {
        placePiece(newShape, p.y, p.x, idx);
        p.currentShape = newShape;
    } else {
        placePiece(oldShape, p.y, p.x, idx); // ì›ë³µ
        showMessage("íšŒì „í•  ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! ğŸš«");
    }
    renderPieces();
}

function checkSolution() {
    let count = 0;
    for(let r=0; r<ROWS; r++) for(let c=0; c<COLS; c++) if(boardState[r][c]!==-1) count++;
    if(count === ROWS*COLS) showMessage("ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤!");
    else showMessage(`ì•„ì§ ${ROWS*COLS - count}ì¹¸ì´ ë‚¨ì•˜ìŠµë‹ˆë‹¤.`);
}

function showAnswer() {
    if(!confirm("ì •ë‹µì„ í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    boardState = JSON.parse(JSON.stringify(answerKey));
    // ì‹œê°ì  ë Œë”ë§ì„ ìœ„í•´ pieces ìœ„ì¹˜ ê°•ì œ ì—…ë°ì´íŠ¸ í•„ìš”í•˜ë‚˜
    // ì—¬ê¸°ì„  ë³´ë“œ ìƒíƒœë§Œ ë³´ì—¬ì£¼ëŠ” ê²ƒìœ¼ë¡œ ë‹¨ìˆœí™”í•˜ê±°ë‚˜ 
    // ìƒˆë¡œ ìƒì„±í•˜ë„ë¡ ìœ ë„
    alert("ì •ë‹µ í™•ì¸ ê¸°ëŠ¥ì€ ê°œë°œì ì½˜ì†”ì„ ì°¸ê³ í•˜ì„¸ìš”. ë‹¤ìŒ ê²Œì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.");
    startGame();
}

function showMessage(t) {
    const m = document.getElementById('message');
    m.textContent = t; m.style.display = 'block';
    setTimeout(()=>m.style.display='none', 2000);
}

// ì´ˆê¸° ì‹¤í–‰
window.addEventListener('resize', () => {
    // ë¦¬ì‚¬ì´ì¦ˆ ì‹œì—ëŠ” ê²Œì„ì„ ë¦¬ì…‹í•˜ì§€ ì•Šê³  í¬ê¸°ë§Œ ì¡°ì •
    initLayout(); 
});

// ìµœì´ˆ ì‹¤í–‰
initLayout();
startGame();

</script>
</body>
</html>
